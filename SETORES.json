[
{
  "model": "desktop.document2",
  "pk": 158920,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SETORES: Criação das tbls",
    "description": "",
    "uuid": "9ec103e7-52f4-36f1-3dc5-e3711d171477",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158920, \"uuid\": \"9ec103e7-52f4-36f1-3dc5-e3711d171477\", \"name\": \"SETORES: Cria\\u00e7\\u00e3o das tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"ff95d3dd-7233-43b7-42f4-b4f783626e4c\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 997, \"column\": 79}, \"errors\": [{\"message\": \"ParseException: Syntax error in line 980:undefined:\\n...==========================\\n                            ^\\nEncountered: EOF\\nExpected: ALTER, COMMENT, COMPUTE, COPY, CREATE, DELETE, DESCRIBE, DROP, EXPLAIN, GRANT, INSERT, INVALIDATE, LOAD, REFRESH, REVOKE, SELECT, SET, SHOW, TRUNCATE, UNSET, UPDATE, UPSERT, USE, VALUES, WITH\\n\\n\\nCAUSED BY: Exception: Syntax error\\n\", \"help\": null, \"line\": 979}], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA - VERS\\u00c3O 4.0\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- Dados do per\\u00edodo: Janeiro/2025 a Agosto/2025 (202501 a 202508)\\r\\n-- ============================================================================\\r\\n-- OBJETIVO:\\r\\n-- An\\u00e1lise setorial profunda para identificar padr\\u00f5es, anomalias e criar \\r\\n-- benchmarks tribut\\u00e1rios. Foco em compara\\u00e7\\u00e3o empresa vs setor sem marca\\u00e7\\u00e3o\\r\\n-- de empresas fiscalizadas.\\r\\n--\\r\\n-- PRINCIPAIS FUNCIONALIDADES:\\r\\n-- 1. Benchmarks setoriais por CNAE (m\\u00e9dia, mediana, percentis, volatilidade)\\r\\n-- 2. An\\u00e1lise granular por porte empresarial dentro de cada setor\\r\\n-- 3. Evolu\\u00e7\\u00e3o temporal de setores e empresas (tend\\u00eancias)\\r\\n-- 4. Detec\\u00e7\\u00e3o de anomalias setoriais e alertas individuais\\r\\n-- 5. An\\u00e1lise de pagamentos vs ICMS devido\\r\\n-- 6. Prepara\\u00e7\\u00e3o de dados para Python/Jupyter/Streamlit\\r\\n-- ============================================================================\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS CORE (FUNDA\\u00c7\\u00c3O DO SISTEMA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. BENCHMARK SETORIAL MENSAL\\r\\n-- Agrega\\u00e7\\u00e3o mensal por CNAE com todas as m\\u00e9tricas estat\\u00edsticas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial;\\r\\nCREATE TABLE niat.argos_benchmark_setorial STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n\\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT d.nu_cnpj) AS qtd_empresas_total,\\r\\n    COUNT(DISTINCT CASE WHEN d.sn_com_movimento = 1 THEN d.nu_cnpj END) AS qtd_empresas_ativas,\\r\\n    COUNT(DISTINCT CASE WHEN d.vl_faturamento > 1000 THEN d.nu_cnpj END) AS qtd_empresas_relevantes,\\r\\n\\r\\n    -- Agregados financeiros (valores brutos para c\\u00e1lculos)\\r\\n    SUM(COALESCE(d.vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(d.vl_receita_bruta, 0)) AS receita_bruta_total,\\r\\n    SUM(COALESCE(d.vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    SUM(COALESCE(d.vl_deb_recolher, 0)) AS icms_recolher_total,\\r\\n    AVG(d.vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva: Estat\\u00edsticas Descritivas (apenas empresas com fat > 1000)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    MIN(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_min,\\r\\n    \\r\\n    MAX(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_max,\\r\\n    \\r\\n    -- Aproxima\\u00e7\\u00f5es de percentis (mediana \\u2248 m\\u00e9dia, P25/P75 usando desvio)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) - \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p25,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) + \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p75,\\r\\n\\r\\n    -- Coeficiente de Varia\\u00e7\\u00e3o Setorial\\r\\n    CASE \\r\\n        WHEN AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) > 0\\r\\n        THEN STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) / \\r\\n             AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END)\\r\\n        ELSE NULL\\r\\n    END AS aliq_coef_variacao,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL\\r\\n    AND SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) IN (\\r\\n        '10','11','12','13','14','15','16','17','18','19',\\r\\n        '20','21','22','23','24','25','26','27','28','29',\\r\\n        '30','31','32','33','35','41','42','43','45','46','47'\\r\\n    )\\r\\nGROUP BY \\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5),\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe,\\r\\n    c.cd_secao,\\r\\n    c.de_secao\\r\\nHAVING \\r\\n    COUNT(DISTINCT d.nu_cnpj) >= 5;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. BENCHMARK SETORIAL POR PORTE\\r\\n-- Estratifica\\u00e7\\u00e3o adicional por porte empresarial dentro de cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial_porte;\\r\\nCREATE TABLE niat.argos_benchmark_setorial_porte STORED AS PARQUET AS\\r\\nWITH empresas_com_porte AS (\\r\\n    SELECT \\r\\n        d.*,\\r\\n        c.cd_cnae,\\r\\n        c.de_classe,\\r\\n        c.cd_secao,\\r\\n        c.de_secao,\\r\\n        CASE\\r\\n            WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n            WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n            WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n            WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n            ELSE 'SEM_FATURAMENTO'\\r\\n        END AS porte_empresa\\r\\n    FROM usr_sat_ods.vw_ods_decl_dime d\\r\\n    INNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\n    WHERE \\r\\n        d.sn_cancelada = 0\\r\\n        AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n        AND c.cd_cnae IS NOT NULL\\r\\n)\\r\\nSELECT\\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    de_classe AS desc_cnae_classe,\\r\\n    porte_empresa,\\r\\n\\r\\n    -- Contagens por porte\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(DISTINCT CASE WHEN sn_com_movimento = 1 THEN nu_cnpj END) AS qtd_empresas_ativas,\\r\\n\\r\\n    -- Estat\\u00edsticas de al\\u00edquota por porte (com prote\\u00e7\\u00e3o contra divis\\u00e3o por zero)\\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n\\r\\n    -- Agregados financeiros\\r\\n    SUM(COALESCE(vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    AVG(vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM empresas_com_porte\\r\\nWHERE porte_empresa != 'SEM_FATURAMENTO'\\r\\nGROUP BY \\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5),\\r\\n    de_classe,\\r\\n    porte_empresa\\r\\nHAVING \\r\\n    COUNT(DISTINCT nu_cnpj) >= 3;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. DADOS INDIVIDUAIS DAS EMPRESAS\\r\\n-- Informa\\u00e7\\u00f5es mensais de cada empresa com porte e al\\u00edquotas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresas;\\r\\nCREATE TABLE niat.argos_empresas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Per\\u00edodo\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    \\r\\n    -- Status da declara\\u00e7\\u00e3o\\r\\n    d.sn_omisso,\\r\\n    d.sn_entregue_prazo,\\r\\n    d.sn_com_movimento,\\r\\n    d.dt_entrega,\\r\\n    d.qt_funcionarios,\\r\\n\\r\\n    -- Porte Empresarial\\r\\n    CASE\\r\\n        WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n        WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n        WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n        WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n        ELSE 'SEM_FATURAMENTO'\\r\\n    END AS porte_empresa,\\r\\n\\r\\n    -- Valores financeiros\\r\\n    d.vl_faturamento,\\r\\n    d.vl_receita_bruta,\\r\\n    d.vl_tot_deb AS icms_devido,\\r\\n    d.vl_deb_recolher AS icms_recolher,\\r\\n    d.vl_tot_sai_bc AS bc_saidas,\\r\\n    d.vl_tot_sai_imposto_creditado AS icms_destacado_saidas,\\r\\n    d.vl_tot_ent_bc AS bc_entradas,\\r\\n    d.vl_tot_ent_imposto_creditado AS icms_creditado_entradas,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva (apenas se faturamento > 1000, com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_faturamento > 1000 AND d.vl_faturamento > 0\\r\\n        THEN d.vl_tot_deb / d.vl_faturamento \\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva,\\r\\n\\r\\n    -- Al\\u00edquota Destacada nas Sa\\u00eddas (com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_tot_sai_bc > 0 \\r\\n        THEN d.vl_tot_sai_imposto_creditado / d.vl_tot_sai_bc \\r\\n        ELSE NULL \\r\\n    END AS aliq_destacada_saidas,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.4. PAGAMENTOS POR EMPRESA (MENSAL)\\r\\n-- Agrega\\u00e7\\u00e3o mensal dos pagamentos de ICMS\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_pagamentos_empresa;\\r\\nCREATE TABLE niat.argos_pagamentos_empresa STORED AS PARQUET AS\\r\\nWITH \\r\\ncnpjs_periodos AS (\\r\\n    SELECT DISTINCT nu_cnpj, nu_per_ref\\r\\n    FROM niat.argos_empresas\\r\\n),\\r\\npagamentos_agg AS (\\r\\n    SELECT \\r\\n        nu_cnpj, \\r\\n        nu_per_pagamento,\\r\\n        COUNT(nu_id_pagamento) AS qtd_pagamentos, \\r\\n        SUM(vl_total) AS valor_total_pago\\r\\n    FROM usr_sat_ods.vw_ods_pagamento\\r\\n    WHERE nu_per_pagamento BETWEEN 202501 AND 202508\\r\\n      AND cd_receita IN (1449, 1465, 1473, 1554, 1570, 1589, 1597, 1600, 1643, \\r\\n                         1651, 1716, 1724, 1732, 1740, 1759, 1767, 1783, 1791, \\r\\n                         2140, 2496, 2526, 2534, 3000, 3050, 3662, 4383, 7110, \\r\\n                         7137, 9687, 9784)\\r\\n    GROUP BY nu_cnpj, nu_per_pagamento\\r\\n)\\r\\nSELECT \\r\\n    c.nu_cnpj,\\r\\n    c.nu_per_ref,\\r\\n    COALESCE(p.qtd_pagamentos, 0) AS qtd_pagamentos,\\r\\n    COALESCE(p.valor_total_pago, 0) AS valor_total_pago,\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM cnpjs_periodos c\\r\\nLEFT JOIN pagamentos_agg p ON c.nu_cnpj = p.nu_cnpj AND c.nu_per_ref = p.nu_per_pagamento;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.5. COMPARA\\u00c7\\u00c3O EMPRESA VS BENCHMARK SETORIAL\\r\\n-- Cruzamento dos dados individuais com benchmarks do setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresa_vs_benchmark;\\r\\nCREATE TABLE niat.argos_empresa_vs_benchmark STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o da empresa\\r\\n    e.nu_cnpj,\\r\\n    e.nu_ie,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.cnae_divisao,\\r\\n    e.desc_cnae_classe,\\r\\n    e.secao,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Dados da empresa\\r\\n    e.vl_faturamento,\\r\\n    e.icms_devido,\\r\\n    e.icms_recolher,\\r\\n    e.aliq_efetiva AS aliq_efetiva_empresa,\\r\\n    e.sn_com_movimento,\\r\\n    e.sn_entregue_prazo,\\r\\n    e.sn_omisso,\\r\\n    \\r\\n    -- Benchmarks do setor (geral)\\r\\n    b.qtd_empresas_total AS empresas_no_setor,\\r\\n    b.aliq_efetiva_media AS aliq_setor_media,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor_mediana,\\r\\n    b.aliq_efetiva_p25 AS aliq_setor_p25,\\r\\n    b.aliq_efetiva_p75 AS aliq_setor_p75,\\r\\n    b.aliq_efetiva_desvio AS aliq_setor_desvio,\\r\\n    b.aliq_coef_variacao AS aliq_setor_coef_variacao,\\r\\n    \\r\\n    -- Benchmarks do setor por porte (quando dispon\\u00edvel)\\r\\n    bp.qtd_empresas AS empresas_mesmo_porte,\\r\\n    bp.aliq_efetiva_media AS aliq_porte_media,\\r\\n    bp.aliq_efetiva_mediana AS aliq_porte_mediana,\\r\\n    bp.aliq_efetiva_desvio AS aliq_porte_desvio,\\r\\n    \\r\\n    -- Dados de pagamento\\r\\n    p.qtd_pagamentos,\\r\\n    p.valor_total_pago,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs setor geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN b.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / b.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_setor,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs mesmo porte (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN bp.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / bp.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_porte,\\r\\n    \\r\\n    -- Status comparativo (baseado em desvios padr\\u00e3o da mediana setorial)\\r\\n    CASE \\r\\n        WHEN e.aliq_efetiva IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN b.aliq_efetiva_desvio IS NULL OR b.aliq_efetiva_desvio = 0 THEN 'NORMAL'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ABAIXO'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - b.aliq_efetiva_desvio) THEN 'ABAIXO'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ACIMA'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + b.aliq_efetiva_desvio) THEN 'ACIMA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS status_vs_setor,\\r\\n    \\r\\n    -- Diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 1\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nINNER JOIN niat.argos_benchmark_setorial b ON \\r\\n    e.cnae_classe = b.cnae_classe \\r\\n    AND e.nu_per_ref = b.nu_per_ref\\r\\nLEFT JOIN niat.argos_benchmark_setorial_porte bp ON\\r\\n    e.cnae_classe = bp.cnae_classe\\r\\n    AND e.nu_per_ref = bp.nu_per_ref\\r\\n    AND e.porte_empresa = bp.porte_empresa\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON\\r\\n    e.nu_cnpj = p.nu_cnpj\\r\\n    AND e.nu_per_ref = p.nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISES TEMPORAIS E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. EVOLU\\u00c7\\u00c3O TEMPORAL SETORIAL\\r\\n-- Tend\\u00eancias de 8 meses para cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_setor;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_setor STORED AS PARQUET AS\\r\\nWITH setor_mensal AS (\\r\\n    SELECT \\r\\n        cnae_classe,\\r\\n        desc_cnae_classe,\\r\\n        secao,\\r\\n        desc_secao,\\r\\n        nu_per_ref,\\r\\n        aliq_efetiva_mediana,\\r\\n        faturamento_total,\\r\\n        icms_devido_total,\\r\\n        qtd_empresas_total\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n),\\r\\nsetor_agregado AS (\\r\\n    SELECT\\r\\n        cnae_classe,\\r\\n        MAX(desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(secao) AS secao,\\r\\n        MAX(desc_secao) AS desc_secao,\\r\\n        \\r\\n        -- Contagens\\r\\n        COUNT(DISTINCT nu_per_ref) AS meses_analisados,\\r\\n        AVG(qtd_empresas_total) AS media_empresas_mes,\\r\\n        \\r\\n        -- M\\u00e9dias temporais\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_media_8m,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_mediana_desvio_8m,\\r\\n        MIN(aliq_efetiva_mediana) AS aliq_mediana_min_8m,\\r\\n        MAX(aliq_efetiva_mediana) AS aliq_mediana_max_8m,\\r\\n        \\r\\n        -- Coeficiente de varia\\u00e7\\u00e3o temporal\\r\\n        CASE \\r\\n            WHEN AVG(aliq_efetiva_mediana) > 0 \\r\\n            THEN STDDEV(aliq_efetiva_mediana) / AVG(aliq_efetiva_mediana)\\r\\n            ELSE NULL \\r\\n        END AS coef_variacao_temporal,\\r\\n        \\r\\n        -- Totais acumulados\\r\\n        SUM(faturamento_total) AS faturamento_acumulado_8m,\\r\\n        SUM(icms_devido_total) AS icms_devido_acumulado_8m,\\r\\n        \\r\\n        -- Al\\u00edquota efetiva acumulada\\r\\n        CASE \\r\\n            WHEN SUM(faturamento_total) > 0 \\r\\n            THEN SUM(icms_devido_total) / SUM(faturamento_total)\\r\\n            ELSE NULL \\r\\n        END AS aliq_efetiva_acumulada_8m,\\r\\n        \\r\\n        -- Tend\\u00eancia simples (compara\\u00e7\\u00e3o primeiro vs \\u00faltimo trimestre)\\r\\n        AVG(CASE WHEN nu_per_ref IN (202501, 202502, 202503) THEN aliq_efetiva_mediana END) AS aliq_media_trim1,\\r\\n        AVG(CASE WHEN nu_per_ref IN (202506, 202507, 202508) THEN aliq_efetiva_mediana END) AS aliq_media_trim3\\r\\n        \\r\\n    FROM setor_mensal\\r\\n    GROUP BY cnae_classe\\r\\n    HAVING COUNT(DISTINCT nu_per_ref) >= 6\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Classifica\\u00e7\\u00e3o de volatilidade temporal\\r\\n    CASE\\r\\n        WHEN coef_variacao_temporal IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN coef_variacao_temporal > 0.3 THEN 'ALTA'\\r\\n        WHEN coef_variacao_temporal > 0.15 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade_temporal,\\r\\n    \\r\\n    -- Tend\\u00eancia geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN aliq_media_trim1 IS NULL OR aliq_media_trim3 IS NULL OR aliq_media_trim1 = 0 THEN 'INDETERMINADA'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) > 0.1 THEN 'CRESCENTE'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) < -0.1 THEN 'DECRESCENTE'\\r\\n        ELSE 'ESTAVEL'\\r\\n    END AS tendencia_aliquota,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM setor_agregado;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. EVOLU\\u00c7\\u00c3O TEMPORAL POR EMPRESA\\r\\n-- Hist\\u00f3rico de 8 meses para cada empresa\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_empresa;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_empresa STORED AS PARQUET AS\\r\\nWITH empresa_agg AS (\\r\\n    SELECT \\r\\n        e.nu_cnpj,\\r\\n        MAX(e.nm_razao_social) AS nm_razao_social,\\r\\n        e.cnae_classe,\\r\\n        MAX(e.desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(e.porte_empresa) AS porte_predominante,\\r\\n        \\r\\n        -- Contagens temporais\\r\\n        COUNT(*) AS meses_com_declaracao,\\r\\n        COUNT(CASE WHEN e.sn_com_movimento = 1 THEN 1 END) AS meses_com_movimento,\\r\\n        COUNT(CASE WHEN e.sn_omisso = 1 THEN 1 END) AS meses_omisso,\\r\\n        \\r\\n        -- Agregados financeiros\\r\\n        SUM(e.vl_faturamento) AS faturamento_total_8m,\\r\\n        SUM(e.icms_devido) AS icms_devido_total_8m,\\r\\n        SUM(e.icms_recolher) AS icms_recolher_total_8m,\\r\\n        AVG(e.vl_faturamento) AS faturamento_medio_8m,\\r\\n        STDDEV(e.vl_faturamento) AS faturamento_desvio_8m,\\r\\n        \\r\\n        -- Estat\\u00edsticas de al\\u00edquota\\r\\n        AVG(e.aliq_efetiva) AS aliq_media_8m,\\r\\n        STDDEV(e.aliq_efetiva) AS aliq_desvio_8m,\\r\\n        MIN(e.aliq_efetiva) AS aliq_min_8m,\\r\\n        MAX(e.aliq_efetiva) AS aliq_max_8m,\\r\\n        \\r\\n        -- Agregados de pagamentos\\r\\n        SUM(p.qtd_pagamentos) AS qtd_pagamentos_total_8m,\\r\\n        SUM(p.valor_total_pago) AS valor_total_pago_8m\\r\\n        \\r\\n    FROM niat.argos_empresas e\\r\\n    LEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n        e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\n    WHERE e.aliq_efetiva IS NOT NULL\\r\\n    GROUP BY e.nu_cnpj, e.cnae_classe\\r\\n    HAVING COUNT(*) >= 3\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o da al\\u00edquota (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN aliq_media_8m > 0 \\r\\n        THEN aliq_desvio_8m / NULLIF(aliq_media_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_coef_variacao_8m,\\r\\n    \\r\\n    -- Categoria de volatilidade\\r\\n    CASE\\r\\n        WHEN aliq_media_8m <= 0 OR aliq_desvio_8m IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.5 THEN 'ALTA'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.2 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade,\\r\\n    \\r\\n    -- Al\\u00edquota efetiva acumulada (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_total_8m > 0 \\r\\n        THEN icms_devido_total_8m / NULLIF(faturamento_total_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva_acumulada_8m,\\r\\n    \\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o do faturamento (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_medio_8m > 0 \\r\\n        THEN faturamento_desvio_8m / NULLIF(faturamento_medio_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS faturamento_coef_variacao_8m,\\r\\n    \\r\\n    -- Flag de diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN icms_recolher_total_8m > 100 AND valor_total_pago_8m = 0 THEN 1\\r\\n        WHEN icms_recolher_total_8m > 0 AND valor_total_pago_8m > 0\\r\\n            AND ABS(icms_recolher_total_8m - valor_total_pago_8m) / NULLIF(icms_recolher_total_8m, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento_8m,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM empresa_agg;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: DETEC\\u00c7\\u00c3O DE ANOMALIAS E ALERTAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. ANOMALIAS SETORIAIS\\r\\n-- Setores com comportamento an\\u00f4malo comparado \\u00e0 economia geral\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_anomalias_setoriais;\\r\\nCREATE TABLE niat.argos_anomalias_setoriais STORED AS PARQUET AS\\r\\nWITH economia_geral AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_economia,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_desvio_economia\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT \\r\\n    b.nu_per_ref,\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.qtd_empresas_total,\\r\\n    b.faturamento_total,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor,\\r\\n    e.aliq_mediana_economia,\\r\\n    \\r\\n    -- \\u00cdndice vs economia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.aliq_mediana_economia > 0 \\r\\n        THEN b.aliq_efetiva_mediana / NULLIF(e.aliq_mediana_economia, 0)\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_economia,\\r\\n    \\r\\n    -- Tipo de anomalia\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 'ALTA_VOLATILIDADE_INTERNA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia) THEN 'ALIQUOTA_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'ALIQUOTA_ALTA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS tipo_anomalia,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.5 THEN 'ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) \\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALTA'\\r\\n        WHEN b.aliq_coef_variacao > 0.3 THEN 'MEDIA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Score de relev\\u00e2ncia (considera faturamento)\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 50 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 45 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 35 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        ELSE 10.0\\r\\n    END AS score_relevancia,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nINNER JOIN economia_geral e ON b.nu_per_ref = e.nu_per_ref\\r\\nWHERE \\r\\n    b.aliq_coef_variacao > 0.3\\r\\n    OR b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n    OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia);\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. ALERTAS INDIVIDUAIS DE EMPRESAS\\r\\n-- Empresas com comportamento fora do padr\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_alertas_empresas;\\r\\nCREATE TABLE niat.argos_alertas_empresas STORED AS PARQUET AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Tipo de alerta\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'ALIQUOTA_MUITO_ABAIXO_SETOR'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'DIVERGENCIA_ICMS_PAGAMENTO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTA_VOLATILIDADE_TEMPORAL'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'ALIQUOTA_ABAIXO_SETOR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'CRITICO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 'CRITICO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'MEDIO'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'MEDIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Detalhes\\r\\n    evb.aliq_efetiva_empresa,\\r\\n    evb.aliq_setor_mediana,\\r\\n    evb.aliq_porte_mediana,\\r\\n    evb.indice_vs_mediana_setor,\\r\\n    evb.vl_faturamento,\\r\\n    evb.icms_devido,\\r\\n    evb.icms_recolher,\\r\\n    evb.valor_total_pago,\\r\\n    ete.aliq_coef_variacao_8m,\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Score de risco ponderado por faturamento\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 50 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 45 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 40 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 30 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        ELSE 15.0\\r\\n    END AS score_risco,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE \\r\\n    evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n    OR evb.flag_divergencia_pagamento = 1\\r\\n    OR ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: VIEWS PARA PYTHON/STREAMLIT\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. DASHBOARD DE SETORES\\r\\n-- Vis\\u00e3o consolidada dos setores para an\\u00e1lises Python\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_setores;\\r\\nCREATE VIEW niat.vw_dashboard_setores AS\\r\\nSELECT \\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- Quantidades\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Valores financeiros (formatados para BR)\\r\\n    REPLACE(CAST(b.faturamento_total / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    REPLACE(CAST(b.icms_devido_total / 1000000 AS STRING), '.', ',') AS icms_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_media * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p25 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p25_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p75 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p75_pct,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    REPLACE(CAST(ROUND(b.aliq_coef_variacao, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    \\r\\n    -- Dados de evolu\\u00e7\\u00e3o temporal (quando dispon\\u00edvel)\\r\\n    et.categoria_volatilidade_temporal,\\r\\n    et.tendencia_aliquota,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    \\r\\n    -- Flags de anomalias\\r\\n    CASE WHEN a.cnae_classe IS NOT NULL THEN 1 ELSE 0 END AS flag_anomalia,\\r\\n    a.tipo_anomalia,\\r\\n    a.severidade AS severidade_anomalia\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor et ON b.cnae_classe = et.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais a ON \\r\\n    b.cnae_classe = a.cnae_classe AND b.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. DASHBOARD DE EMPRESAS\\r\\n-- Dados individuais com compara\\u00e7\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_empresas;\\r\\nCREATE VIEW niat.vw_dashboard_empresas AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores financeiros (formatados)\\r\\n    REPLACE(CAST(evb.vl_faturamento AS STRING), '.', ',') AS faturamento,\\r\\n    REPLACE(CAST(evb.icms_devido AS STRING), '.', ',') AS icms_devido,\\r\\n    REPLACE(CAST(evb.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(evb.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_efetiva_empresa * 100, 2) AS STRING), '.', ','), '%') AS aliq_empresa_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_setor_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_setor_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_porte_pct,\\r\\n    \\r\\n    -- \\u00cdndices\\r\\n    REPLACE(CAST(ROUND(evb.indice_vs_mediana_setor, 2) AS STRING), '.', ',') AS indice_vs_setor,\\r\\n    \\r\\n    -- Status\\r\\n    evb.status_vs_setor,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Dados temporais (8 meses)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao_8m,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade AS severidade_alerta,\\r\\n    REPLACE(CAST(ROUND(a.score_risco, 1) AS STRING), '.', ',') AS score_risco\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. AN\\u00c1LISE DE VOLATILIDADE\\r\\n-- Empresas e setores com alta volatilidade\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_analise_volatilidade;\\r\\nCREATE VIEW niat.vw_analise_volatilidade AS\\r\\nSELECT \\r\\n    'SETOR' AS tipo,\\r\\n    et.cnae_classe AS identificador,\\r\\n    et.desc_cnae_classe AS descricao,\\r\\n    et.categoria_volatilidade_temporal AS categoria,\\r\\n    REPLACE(CAST(ROUND(et.coef_variacao_temporal, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(et.faturamento_acumulado_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor et\\r\\nWHERE et.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EMPRESA' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(ete.faturamento_total_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. RELA\\u00c7\\u00c3O ICMS vs PAGAMENTOS\\r\\n-- An\\u00e1lise de diverg\\u00eancias entre ICMS devido e pagamentos\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_relacao_icms_pagamentos;\\r\\nCREATE VIEW niat.vw_relacao_icms_pagamentos AS\\r\\nSELECT \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Valores (formatados)\\r\\n    REPLACE(CAST(e.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(p.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    REPLACE(CAST(p.qtd_pagamentos AS STRING), '.', ',') AS qtd_pagamentos,\\r\\n    \\r\\n    -- Diverg\\u00eancia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n        THEN REPLACE(CAST(ROUND((e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1) AS STRING), '.', ',')\\r\\n        ELSE NULL \\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.1 THEN 'DIVERGENCIA_MEDIA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 THEN 'NORMAL'\\r\\n        ELSE 'SEM_DADOS'\\r\\n    END AS classificacao_divergencia\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n    e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nWHERE e.icms_recolher IS NOT NULL OR p.valor_total_pago IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Contagem de registros em todas as tabelas\\r\\nSELECT 'RESUMO DO SISTEMA V4.0' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_benchmark_setorial\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial_porte' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT porte_empresa) AS portes\\r\\nFROM niat.argos_benchmark_setorial_porte\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_empresas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_pagamentos_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    SUM(qtd_pagamentos) AS total_pagamentos\\r\\nFROM niat.argos_pagamentos_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresa_vs_benchmark' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores\\r\\nFROM niat.argos_empresa_vs_benchmark\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_setor' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_anomalias_setoriais' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_anomalos,\\r\\n    COUNT(DISTINCT tipo_anomalia) AS tipos\\r\\nFROM niat.argos_anomalias_setoriais\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_alertas_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_alerta,\\r\\n    COUNT(DISTINCT tipo_alerta) AS tipos\\r\\nFROM niat.argos_alertas_empresas;\\r\\n\\r\\n-- Distribui\\u00e7\\u00e3o de alertas\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    tipo_alerta,\\r\\n    severidade,\\r\\n    COUNT(*) AS quantidade,\\r\\n    REPLACE(CAST(ROUND(AVG(score_risco), 1) AS STRING), '.', ',') AS score_medio\\r\\nFROM niat.argos_alertas_empresas\\r\\nGROUP BY tipo_alerta, severidade\\r\\nORDER BY AVG(score_risco) DESC;\\r\\n\\r\\n-- Top 10 setores por faturamento\\r\\nSELECT \\r\\n    'TOP 10 SETORES POR FATURAMENTO' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    REPLACE(CAST(SUM(faturamento_total) / 1000000000 AS STRING), '.', ',') AS faturamento_bilhoes,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos,\\r\\n    CONCAT(REPLACE(CAST(ROUND(AVG(aliq_efetiva_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_media\\r\\nFROM niat.argos_benchmark_setorial\\r\\nGROUP BY cnae_classe, desc_cnae_classe\\r\\nORDER BY SUM(faturamento_total) DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DO SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA V4.0\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- PR\\u00d3XIMOS PASSOS SUGERIDOS PARA PYTHON/JUPYTER:\\r\\n-- \\r\\n-- 1. Importar as views principais:\\r\\n--    - niat.vw_dashboard_setores\\r\\n--    - niat.vw_dashboard_empresas\\r\\n--    - niat.vw_analise_volatilidade\\r\\n--    - niat.vw_relacao_icms_pagamentos\\r\\n--\\r\\n-- 2. Criar visualiza\\u00e7\\u00f5es no Streamlit:\\r\\n--    - Gr\\u00e1ficos de evolu\\u00e7\\u00e3o temporal por setor\\r\\n--    - Mapa de calor de al\\u00edquotas por CNAE\\r\\n--    - Distribui\\u00e7\\u00e3o de empresas por quartil de al\\u00edquota\\r\\n--    - An\\u00e1lise de diverg\\u00eancias ICMS vs pagamentos\\r\\n--    - Ranking de setores com anomalias\\r\\n--\\r\\n-- 3. An\\u00e1lises estat\\u00edsticas avan\\u00e7adas:\\r\\n--    - Clustering de setores similares\\r\\n--    - Detec\\u00e7\\u00e3o de outliers por setor\\r\\n--    - Previs\\u00e3o de tend\\u00eancias de al\\u00edquotas\\r\\n--    - An\\u00e1lise de correla\\u00e7\\u00e3o entre vari\\u00e1veis\\r\\n--\\r\\n-- ============================================================================\", \"statementsList\": [\"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: DETEC\\u00c7\\u00c3O DE ANOMALIAS E ALERTAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. ANOMALIAS SETORIAIS\\r\\n-- Setores com comportamento an\\u00f4malo comparado \\u00e0 economia geral\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_anomalias_setoriais;\", \"\\r\\nCREATE TABLE niat.argos_anomalias_setoriais STORED AS PARQUET AS\\r\\nWITH economia_geral AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_economia,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_desvio_economia\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT \\r\\n    b.nu_per_ref,\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.qtd_empresas_total,\\r\\n    b.faturamento_total,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor,\\r\\n    e.aliq_mediana_economia,\\r\\n    \\r\\n    -- \\u00cdndice vs economia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.aliq_mediana_economia > 0 \\r\\n        THEN b.aliq_efetiva_mediana / NULLIF(e.aliq_mediana_economia, 0)\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_economia,\\r\\n    \\r\\n    -- Tipo de anomalia\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 'ALTA_VOLATILIDADE_INTERNA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia) THEN 'ALIQUOTA_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'ALIQUOTA_ALTA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS tipo_anomalia,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.5 THEN 'ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) \\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALTA'\\r\\n        WHEN b.aliq_coef_variacao > 0.3 THEN 'MEDIA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Score de relev\\u00e2ncia (considera faturamento)\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 50 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 45 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 35 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        ELSE 10.0\\r\\n    END AS score_relevancia,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nINNER JOIN economia_geral e ON b.nu_per_ref = e.nu_per_ref\\r\\nWHERE \\r\\n    b.aliq_coef_variacao > 0.3\\r\\n    OR b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n    OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia);\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. ALERTAS INDIVIDUAIS DE EMPRESAS\\r\\n-- Empresas com comportamento fora do padr\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_alertas_empresas;\", \"\\r\\nCREATE TABLE niat.argos_alertas_empresas STORED AS PARQUET AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Tipo de alerta\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'ALIQUOTA_MUITO_ABAIXO_SETOR'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'DIVERGENCIA_ICMS_PAGAMENTO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTA_VOLATILIDADE_TEMPORAL'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'ALIQUOTA_ABAIXO_SETOR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'CRITICO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 'CRITICO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'MEDIO'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'MEDIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Detalhes\\r\\n    evb.aliq_efetiva_empresa,\\r\\n    evb.aliq_setor_mediana,\\r\\n    evb.aliq_porte_mediana,\\r\\n    evb.indice_vs_mediana_setor,\\r\\n    evb.vl_faturamento,\\r\\n    evb.icms_devido,\\r\\n    evb.icms_recolher,\\r\\n    evb.valor_total_pago,\\r\\n    ete.aliq_coef_variacao_8m,\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Score de risco ponderado por faturamento\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 50 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 45 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 40 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 30 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        ELSE 15.0\\r\\n    END AS score_risco,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE \\r\\n    evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n    OR evb.flag_divergencia_pagamento = 1\\r\\n    OR ete.categoria_volatilidade = 'ALTA';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: VIEWS PARA PYTHON/STREAMLIT\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. DASHBOARD DE SETORES\\r\\n-- Vis\\u00e3o consolidada dos setores para an\\u00e1lises Python\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_setores;\", \"\\r\\nCREATE VIEW niat.vw_dashboard_setores AS\\r\\nSELECT \\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- Quantidades\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Valores financeiros (formatados para BR)\\r\\n    REPLACE(CAST(b.faturamento_total / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    REPLACE(CAST(b.icms_devido_total / 1000000 AS STRING), '.', ',') AS icms_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_media * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p25 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p25_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p75 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p75_pct,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    REPLACE(CAST(ROUND(b.aliq_coef_variacao, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    \\r\\n    -- Dados de evolu\\u00e7\\u00e3o temporal (quando dispon\\u00edvel)\\r\\n    et.categoria_volatilidade_temporal,\\r\\n    et.tendencia_aliquota,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    \\r\\n    -- Flags de anomalias\\r\\n    CASE WHEN a.cnae_classe IS NOT NULL THEN 1 ELSE 0 END AS flag_anomalia,\\r\\n    a.tipo_anomalia,\\r\\n    a.severidade AS severidade_anomalia\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor et ON b.cnae_classe = et.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais a ON \\r\\n    b.cnae_classe = a.cnae_classe AND b.nu_per_ref = a.nu_per_ref;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. DASHBOARD DE EMPRESAS\\r\\n-- Dados individuais com compara\\u00e7\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_empresas;\", \"\\r\\nCREATE VIEW niat.vw_dashboard_empresas AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores financeiros (formatados)\\r\\n    REPLACE(CAST(evb.vl_faturamento AS STRING), '.', ',') AS faturamento,\\r\\n    REPLACE(CAST(evb.icms_devido AS STRING), '.', ',') AS icms_devido,\\r\\n    REPLACE(CAST(evb.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(evb.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_efetiva_empresa * 100, 2) AS STRING), '.', ','), '%') AS aliq_empresa_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_setor_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_setor_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_porte_pct,\\r\\n    \\r\\n    -- \\u00cdndices\\r\\n    REPLACE(CAST(ROUND(evb.indice_vs_mediana_setor, 2) AS STRING), '.', ',') AS indice_vs_setor,\\r\\n    \\r\\n    -- Status\\r\\n    evb.status_vs_setor,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Dados temporais (8 meses)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao_8m,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade AS severidade_alerta,\\r\\n    REPLACE(CAST(ROUND(a.score_risco, 1) AS STRING), '.', ',') AS score_risco\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. AN\\u00c1LISE DE VOLATILIDADE\\r\\n-- Empresas e setores com alta volatilidade\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_analise_volatilidade;\", \"\\r\\nCREATE VIEW niat.vw_analise_volatilidade AS\\r\\nSELECT \\r\\n    'SETOR' AS tipo,\\r\\n    et.cnae_classe AS identificador,\\r\\n    et.desc_cnae_classe AS descricao,\\r\\n    et.categoria_volatilidade_temporal AS categoria,\\r\\n    REPLACE(CAST(ROUND(et.coef_variacao_temporal, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(et.faturamento_acumulado_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor et\\r\\nWHERE et.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EMPRESA' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(ete.faturamento_total_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA';\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. RELA\\u00c7\\u00c3O ICMS vs PAGAMENTOS\\r\\n-- An\\u00e1lise de diverg\\u00eancias entre ICMS devido e pagamentos\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_relacao_icms_pagamentos;\", \"\\r\\nCREATE VIEW niat.vw_relacao_icms_pagamentos AS\\r\\nSELECT \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Valores (formatados)\\r\\n    REPLACE(CAST(e.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(p.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    REPLACE(CAST(p.qtd_pagamentos AS STRING), '.', ',') AS qtd_pagamentos,\\r\\n    \\r\\n    -- Diverg\\u00eancia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n        THEN REPLACE(CAST(ROUND((e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1) AS STRING), '.', ',')\\r\\n        ELSE NULL \\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.1 THEN 'DIVERGENCIA_MEDIA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 THEN 'NORMAL'\\r\\n        ELSE 'SEM_DADOS'\\r\\n    END AS classificacao_divergencia\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n    e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nWHERE e.icms_recolher IS NOT NULL OR p.valor_total_pago IS NOT NULL;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Contagem de registros em todas as tabelas\\r\\nSELECT 'RESUMO DO SISTEMA V4.0' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_benchmark_setorial\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial_porte' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT porte_empresa) AS portes\\r\\nFROM niat.argos_benchmark_setorial_porte\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_empresas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_pagamentos_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    SUM(qtd_pagamentos) AS total_pagamentos\\r\\nFROM niat.argos_pagamentos_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresa_vs_benchmark' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores\\r\\nFROM niat.argos_empresa_vs_benchmark\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_setor' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_anomalias_setoriais' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_anomalos,\\r\\n    COUNT(DISTINCT tipo_anomalia) AS tipos\\r\\nFROM niat.argos_anomalias_setoriais\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_alertas_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_alerta,\\r\\n    COUNT(DISTINCT tipo_alerta) AS tipos\\r\\nFROM niat.argos_alertas_empresas;\", \"\\r\\n\\r\\n-- Distribui\\u00e7\\u00e3o de alertas\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    tipo_alerta,\\r\\n    severidade,\\r\\n    COUNT(*) AS quantidade,\\r\\n    REPLACE(CAST(ROUND(AVG(score_risco), 1) AS STRING), '.', ',') AS score_medio\\r\\nFROM niat.argos_alertas_empresas\\r\\nGROUP BY tipo_alerta, severidade\\r\\nORDER BY AVG(score_risco) DESC;\", \"\\r\\n\\r\\n-- Top 10 setores por faturamento\\r\\nSELECT \\r\\n    'TOP 10 SETORES POR FATURAMENTO' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    REPLACE(CAST(SUM(faturamento_total) / 1000000000 AS STRING), '.', ',') AS faturamento_bilhoes,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos,\\r\\n    CONCAT(REPLACE(CAST(ROUND(AVG(aliq_efetiva_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_media\\r\\nFROM niat.argos_benchmark_setorial\\r\\nGROUP BY cnae_classe, desc_cnae_classe\\r\\nORDER BY SUM(faturamento_total) DESC\\r\\nLIMIT 10;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DO SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA V4.0\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- PR\\u00d3XIMOS PASSOS SUGERIDOS PARA PYTHON/JUPYTER:\\r\\n-- \\r\\n-- 1. Importar as views principais:\\r\\n--    - niat.vw_dashboard_setores\\r\\n--    - niat.vw_dashboard_empresas\\r\\n--    - niat.vw_analise_volatilidade\\r\\n--    - niat.vw_relacao_icms_pagamentos\\r\\n--\\r\\n-- 2. Criar visualiza\\u00e7\\u00f5es no Streamlit:\\r\\n--    - Gr\\u00e1ficos de evolu\\u00e7\\u00e3o temporal por setor\\r\\n--    - Mapa de calor de al\\u00edquotas por CNAE\\r\\n--    - Distribui\\u00e7\\u00e3o de empresas por quartil de al\\u00edquota\\r\\n--    - An\\u00e1lise de diverg\\u00eancias ICMS vs pagamentos\\r\\n--    - Ranking de setores com anomalias\\r\\n--\\r\\n-- 3. An\\u00e1lises estat\\u00edsticas avan\\u00e7adas:\\r\\n--    - Clustering de setores similares\\r\\n--    - Detec\\u00e7\\u00e3o de outliers por setor\\r\\n--    - Previs\\u00e3o de tend\\u00eancias de al\\u00edquotas\\r\\n--    - An\\u00e1lise de correla\\u00e7\\u00e3o entre vari\\u00e1veis\\r\\n--\\r\\n-- ============================================================================\"], \"aceSize\": 100, \"status\": \"failed\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA - VERS\\u00c3O 4.0\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- Dados do per\\u00edodo: Janeiro/2025 a Agosto/2025 (202501 a 202508)\\r\\n-- ============================================================================\\r\\n-- OBJETIVO:\\r\\n-- An\\u00e1lise setorial profunda para identificar padr\\u00f5es, anomalias e criar \\r\\n-- benchmarks tribut\\u00e1rios. Foco em compara\\u00e7\\u00e3o empresa vs setor sem marca\\u00e7\\u00e3o\\r\\n-- de empresas fiscalizadas.\\r\\n--\\r\\n-- PRINCIPAIS FUNCIONALIDADES:\\r\\n-- 1. Benchmarks setoriais por CNAE (m\\u00e9dia, mediana, percentis, volatilidade)\\r\\n-- 2. An\\u00e1lise granular por porte empresarial dentro de cada setor\\r\\n-- 3. Evolu\\u00e7\\u00e3o temporal de setores e empresas (tend\\u00eancias)\\r\\n-- 4. Detec\\u00e7\\u00e3o de anomalias setoriais e alertas individuais\\r\\n-- 5. An\\u00e1lise de pagamentos vs ICMS devido\\r\\n-- 6. Prepara\\u00e7\\u00e3o de dados para Python/Jupyter/Streamlit\\r\\n-- ============================================================================\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS CORE (FUNDA\\u00c7\\u00c3O DO SISTEMA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. BENCHMARK SETORIAL MENSAL\\r\\n-- Agrega\\u00e7\\u00e3o mensal por CNAE com todas as m\\u00e9tricas estat\\u00edsticas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial;\\r\\nCREATE TABLE niat.argos_benchmark_setorial STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n\\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT d.nu_cnpj) AS qtd_empresas_total,\\r\\n    COUNT(DISTINCT CASE WHEN d.sn_com_movimento = 1 THEN d.nu_cnpj END) AS qtd_empresas_ativas,\\r\\n    COUNT(DISTINCT CASE WHEN d.vl_faturamento > 1000 THEN d.nu_cnpj END) AS qtd_empresas_relevantes,\\r\\n\\r\\n    -- Agregados financeiros (valores brutos para c\\u00e1lculos)\\r\\n    SUM(COALESCE(d.vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(d.vl_receita_bruta, 0)) AS receita_bruta_total,\\r\\n    SUM(COALESCE(d.vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    SUM(COALESCE(d.vl_deb_recolher, 0)) AS icms_recolher_total,\\r\\n    AVG(d.vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva: Estat\\u00edsticas Descritivas (apenas empresas com fat > 1000)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    MIN(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_min,\\r\\n    \\r\\n    MAX(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_max,\\r\\n    \\r\\n    -- Aproxima\\u00e7\\u00f5es de percentis (mediana \\u2248 m\\u00e9dia, P25/P75 usando desvio)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) - \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p25,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) + \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p75,\\r\\n\\r\\n    -- Coeficiente de Varia\\u00e7\\u00e3o Setorial\\r\\n    CASE \\r\\n        WHEN AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) > 0\\r\\n        THEN STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) / \\r\\n             AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END)\\r\\n        ELSE NULL\\r\\n    END AS aliq_coef_variacao,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL\\r\\n    AND SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) IN (\\r\\n        '10','11','12','13','14','15','16','17','18','19',\\r\\n        '20','21','22','23','24','25','26','27','28','29',\\r\\n        '30','31','32','33','35','41','42','43','45','46','47'\\r\\n    )\\r\\nGROUP BY \\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5),\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe,\\r\\n    c.cd_secao,\\r\\n    c.de_secao\\r\\nHAVING \\r\\n    COUNT(DISTINCT d.nu_cnpj) >= 5;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. BENCHMARK SETORIAL POR PORTE\\r\\n-- Estratifica\\u00e7\\u00e3o adicional por porte empresarial dentro de cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial_porte;\\r\\nCREATE TABLE niat.argos_benchmark_setorial_porte STORED AS PARQUET AS\\r\\nWITH empresas_com_porte AS (\\r\\n    SELECT \\r\\n        d.*,\\r\\n        c.cd_cnae,\\r\\n        c.de_classe,\\r\\n        c.cd_secao,\\r\\n        c.de_secao,\\r\\n        CASE\\r\\n            WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n            WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n            WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n            WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n            ELSE 'SEM_FATURAMENTO'\\r\\n        END AS porte_empresa\\r\\n    FROM usr_sat_ods.vw_ods_decl_dime d\\r\\n    INNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\n    WHERE \\r\\n        d.sn_cancelada = 0\\r\\n        AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n        AND c.cd_cnae IS NOT NULL\\r\\n)\\r\\nSELECT\\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    de_classe AS desc_cnae_classe,\\r\\n    porte_empresa,\\r\\n\\r\\n    -- Contagens por porte\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(DISTINCT CASE WHEN sn_com_movimento = 1 THEN nu_cnpj END) AS qtd_empresas_ativas,\\r\\n\\r\\n    -- Estat\\u00edsticas de al\\u00edquota por porte (com prote\\u00e7\\u00e3o contra divis\\u00e3o por zero)\\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n\\r\\n    -- Agregados financeiros\\r\\n    SUM(COALESCE(vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    AVG(vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM empresas_com_porte\\r\\nWHERE porte_empresa != 'SEM_FATURAMENTO'\\r\\nGROUP BY \\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5),\\r\\n    de_classe,\\r\\n    porte_empresa\\r\\nHAVING \\r\\n    COUNT(DISTINCT nu_cnpj) >= 3;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. DADOS INDIVIDUAIS DAS EMPRESAS\\r\\n-- Informa\\u00e7\\u00f5es mensais de cada empresa com porte e al\\u00edquotas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresas;\\r\\nCREATE TABLE niat.argos_empresas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Per\\u00edodo\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    \\r\\n    -- Status da declara\\u00e7\\u00e3o\\r\\n    d.sn_omisso,\\r\\n    d.sn_entregue_prazo,\\r\\n    d.sn_com_movimento,\\r\\n    d.dt_entrega,\\r\\n    d.qt_funcionarios,\\r\\n\\r\\n    -- Porte Empresarial\\r\\n    CASE\\r\\n        WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n        WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n        WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n        WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n        ELSE 'SEM_FATURAMENTO'\\r\\n    END AS porte_empresa,\\r\\n\\r\\n    -- Valores financeiros\\r\\n    d.vl_faturamento,\\r\\n    d.vl_receita_bruta,\\r\\n    d.vl_tot_deb AS icms_devido,\\r\\n    d.vl_deb_recolher AS icms_recolher,\\r\\n    d.vl_tot_sai_bc AS bc_saidas,\\r\\n    d.vl_tot_sai_imposto_creditado AS icms_destacado_saidas,\\r\\n    d.vl_tot_ent_bc AS bc_entradas,\\r\\n    d.vl_tot_ent_imposto_creditado AS icms_creditado_entradas,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva (apenas se faturamento > 1000, com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_faturamento > 1000 AND d.vl_faturamento > 0\\r\\n        THEN d.vl_tot_deb / d.vl_faturamento \\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva,\\r\\n\\r\\n    -- Al\\u00edquota Destacada nas Sa\\u00eddas (com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_tot_sai_bc > 0 \\r\\n        THEN d.vl_tot_sai_imposto_creditado / d.vl_tot_sai_bc \\r\\n        ELSE NULL \\r\\n    END AS aliq_destacada_saidas,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.4. PAGAMENTOS POR EMPRESA (MENSAL)\\r\\n-- Agrega\\u00e7\\u00e3o mensal dos pagamentos de ICMS\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_pagamentos_empresa;\\r\\nCREATE TABLE niat.argos_pagamentos_empresa STORED AS PARQUET AS\\r\\nWITH \\r\\ncnpjs_periodos AS (\\r\\n    SELECT DISTINCT nu_cnpj, nu_per_ref\\r\\n    FROM niat.argos_empresas\\r\\n),\\r\\npagamentos_agg AS (\\r\\n    SELECT \\r\\n        nu_cnpj, \\r\\n        nu_per_pagamento,\\r\\n        COUNT(nu_id_pagamento) AS qtd_pagamentos, \\r\\n        SUM(vl_total) AS valor_total_pago\\r\\n    FROM usr_sat_ods.vw_ods_pagamento\\r\\n    WHERE nu_per_pagamento BETWEEN 202501 AND 202508\\r\\n      AND cd_receita IN (1449, 1465, 1473, 1554, 1570, 1589, 1597, 1600, 1643, \\r\\n                         1651, 1716, 1724, 1732, 1740, 1759, 1767, 1783, 1791, \\r\\n                         2140, 2496, 2526, 2534, 3000, 3050, 3662, 4383, 7110, \\r\\n                         7137, 9687, 9784)\\r\\n    GROUP BY nu_cnpj, nu_per_pagamento\\r\\n)\\r\\nSELECT \\r\\n    c.nu_cnpj,\\r\\n    c.nu_per_ref,\\r\\n    COALESCE(p.qtd_pagamentos, 0) AS qtd_pagamentos,\\r\\n    COALESCE(p.valor_total_pago, 0) AS valor_total_pago,\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM cnpjs_periodos c\\r\\nLEFT JOIN pagamentos_agg p ON c.nu_cnpj = p.nu_cnpj AND c.nu_per_ref = p.nu_per_pagamento;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.5. COMPARA\\u00c7\\u00c3O EMPRESA VS BENCHMARK SETORIAL\\r\\n-- Cruzamento dos dados individuais com benchmarks do setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresa_vs_benchmark;\\r\\nCREATE TABLE niat.argos_empresa_vs_benchmark STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o da empresa\\r\\n    e.nu_cnpj,\\r\\n    e.nu_ie,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.cnae_divisao,\\r\\n    e.desc_cnae_classe,\\r\\n    e.secao,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Dados da empresa\\r\\n    e.vl_faturamento,\\r\\n    e.icms_devido,\\r\\n    e.icms_recolher,\\r\\n    e.aliq_efetiva AS aliq_efetiva_empresa,\\r\\n    e.sn_com_movimento,\\r\\n    e.sn_entregue_prazo,\\r\\n    e.sn_omisso,\\r\\n    \\r\\n    -- Benchmarks do setor (geral)\\r\\n    b.qtd_empresas_total AS empresas_no_setor,\\r\\n    b.aliq_efetiva_media AS aliq_setor_media,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor_mediana,\\r\\n    b.aliq_efetiva_p25 AS aliq_setor_p25,\\r\\n    b.aliq_efetiva_p75 AS aliq_setor_p75,\\r\\n    b.aliq_efetiva_desvio AS aliq_setor_desvio,\\r\\n    b.aliq_coef_variacao AS aliq_setor_coef_variacao,\\r\\n    \\r\\n    -- Benchmarks do setor por porte (quando dispon\\u00edvel)\\r\\n    bp.qtd_empresas AS empresas_mesmo_porte,\\r\\n    bp.aliq_efetiva_media AS aliq_porte_media,\\r\\n    bp.aliq_efetiva_mediana AS aliq_porte_mediana,\\r\\n    bp.aliq_efetiva_desvio AS aliq_porte_desvio,\\r\\n    \\r\\n    -- Dados de pagamento\\r\\n    p.qtd_pagamentos,\\r\\n    p.valor_total_pago,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs setor geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN b.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / b.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_setor,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs mesmo porte (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN bp.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / bp.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_porte,\\r\\n    \\r\\n    -- Status comparativo (baseado em desvios padr\\u00e3o da mediana setorial)\\r\\n    CASE \\r\\n        WHEN e.aliq_efetiva IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN b.aliq_efetiva_desvio IS NULL OR b.aliq_efetiva_desvio = 0 THEN 'NORMAL'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ABAIXO'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - b.aliq_efetiva_desvio) THEN 'ABAIXO'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ACIMA'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + b.aliq_efetiva_desvio) THEN 'ACIMA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS status_vs_setor,\\r\\n    \\r\\n    -- Diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 1\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nINNER JOIN niat.argos_benchmark_setorial b ON \\r\\n    e.cnae_classe = b.cnae_classe \\r\\n    AND e.nu_per_ref = b.nu_per_ref\\r\\nLEFT JOIN niat.argos_benchmark_setorial_porte bp ON\\r\\n    e.cnae_classe = bp.cnae_classe\\r\\n    AND e.nu_per_ref = bp.nu_per_ref\\r\\n    AND e.porte_empresa = bp.porte_empresa\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON\\r\\n    e.nu_cnpj = p.nu_cnpj\\r\\n    AND e.nu_per_ref = p.nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISES TEMPORAIS E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. EVOLU\\u00c7\\u00c3O TEMPORAL SETORIAL\\r\\n-- Tend\\u00eancias de 8 meses para cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_setor;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_setor STORED AS PARQUET AS\\r\\nWITH setor_mensal AS (\\r\\n    SELECT \\r\\n        cnae_classe,\\r\\n        desc_cnae_classe,\\r\\n        secao,\\r\\n        desc_secao,\\r\\n        nu_per_ref,\\r\\n        aliq_efetiva_mediana,\\r\\n        faturamento_total,\\r\\n        icms_devido_total,\\r\\n        qtd_empresas_total\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n),\\r\\nsetor_agregado AS (\\r\\n    SELECT\\r\\n        cnae_classe,\\r\\n        MAX(desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(secao) AS secao,\\r\\n        MAX(desc_secao) AS desc_secao,\\r\\n        \\r\\n        -- Contagens\\r\\n        COUNT(DISTINCT nu_per_ref) AS meses_analisados,\\r\\n        AVG(qtd_empresas_total) AS media_empresas_mes,\\r\\n        \\r\\n        -- M\\u00e9dias temporais\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_media_8m,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_mediana_desvio_8m,\\r\\n        MIN(aliq_efetiva_mediana) AS aliq_mediana_min_8m,\\r\\n        MAX(aliq_efetiva_mediana) AS aliq_mediana_max_8m,\\r\\n        \\r\\n        -- Coeficiente de varia\\u00e7\\u00e3o temporal\\r\\n        CASE \\r\\n            WHEN AVG(aliq_efetiva_mediana) > 0 \\r\\n            THEN STDDEV(aliq_efetiva_mediana) / AVG(aliq_efetiva_mediana)\\r\\n            ELSE NULL \\r\\n        END AS coef_variacao_temporal,\\r\\n        \\r\\n        -- Totais acumulados\\r\\n        SUM(faturamento_total) AS faturamento_acumulado_8m,\\r\\n        SUM(icms_devido_total) AS icms_devido_acumulado_8m,\\r\\n        \\r\\n        -- Al\\u00edquota efetiva acumulada\\r\\n        CASE \\r\\n            WHEN SUM(faturamento_total) > 0 \\r\\n            THEN SUM(icms_devido_total) / SUM(faturamento_total)\\r\\n            ELSE NULL \\r\\n        END AS aliq_efetiva_acumulada_8m,\\r\\n        \\r\\n        -- Tend\\u00eancia simples (compara\\u00e7\\u00e3o primeiro vs \\u00faltimo trimestre)\\r\\n        AVG(CASE WHEN nu_per_ref IN (202501, 202502, 202503) THEN aliq_efetiva_mediana END) AS aliq_media_trim1,\\r\\n        AVG(CASE WHEN nu_per_ref IN (202506, 202507, 202508) THEN aliq_efetiva_mediana END) AS aliq_media_trim3\\r\\n        \\r\\n    FROM setor_mensal\\r\\n    GROUP BY cnae_classe\\r\\n    HAVING COUNT(DISTINCT nu_per_ref) >= 6\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Classifica\\u00e7\\u00e3o de volatilidade temporal\\r\\n    CASE\\r\\n        WHEN coef_variacao_temporal IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN coef_variacao_temporal > 0.3 THEN 'ALTA'\\r\\n        WHEN coef_variacao_temporal > 0.15 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade_temporal,\\r\\n    \\r\\n    -- Tend\\u00eancia geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN aliq_media_trim1 IS NULL OR aliq_media_trim3 IS NULL OR aliq_media_trim1 = 0 THEN 'INDETERMINADA'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) > 0.1 THEN 'CRESCENTE'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) < -0.1 THEN 'DECRESCENTE'\\r\\n        ELSE 'ESTAVEL'\\r\\n    END AS tendencia_aliquota,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM setor_agregado;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. EVOLU\\u00c7\\u00c3O TEMPORAL POR EMPRESA\\r\\n-- Hist\\u00f3rico de 8 meses para cada empresa\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_empresa;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_empresa STORED AS PARQUET AS\\r\\nWITH empresa_agg AS (\\r\\n    SELECT \\r\\n        e.nu_cnpj,\\r\\n        MAX(e.nm_razao_social) AS nm_razao_social,\\r\\n        e.cnae_classe,\\r\\n        MAX(e.desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(e.porte_empresa) AS porte_predominante,\\r\\n        \\r\\n        -- Contagens temporais\\r\\n        COUNT(*) AS meses_com_declaracao,\\r\\n        COUNT(CASE WHEN e.sn_com_movimento = 1 THEN 1 END) AS meses_com_movimento,\\r\\n        COUNT(CASE WHEN e.sn_omisso = 1 THEN 1 END) AS meses_omisso,\\r\\n        \\r\\n        -- Agregados financeiros\\r\\n        SUM(e.vl_faturamento) AS faturamento_total_8m,\\r\\n        SUM(e.icms_devido) AS icms_devido_total_8m,\\r\\n        SUM(e.icms_recolher) AS icms_recolher_total_8m,\\r\\n        AVG(e.vl_faturamento) AS faturamento_medio_8m,\\r\\n        STDDEV(e.vl_faturamento) AS faturamento_desvio_8m,\\r\\n        \\r\\n        -- Estat\\u00edsticas de al\\u00edquota\\r\\n        AVG(e.aliq_efetiva) AS aliq_media_8m,\\r\\n        STDDEV(e.aliq_efetiva) AS aliq_desvio_8m,\\r\\n        MIN(e.aliq_efetiva) AS aliq_min_8m,\\r\\n        MAX(e.aliq_efetiva) AS aliq_max_8m,\\r\\n        \\r\\n        -- Agregados de pagamentos\\r\\n        SUM(p.qtd_pagamentos) AS qtd_pagamentos_total_8m,\\r\\n        SUM(p.valor_total_pago) AS valor_total_pago_8m\\r\\n        \\r\\n    FROM niat.argos_empresas e\\r\\n    LEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n        e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\n    WHERE e.aliq_efetiva IS NOT NULL\\r\\n    GROUP BY e.nu_cnpj, e.cnae_classe\\r\\n    HAVING COUNT(*) >= 3\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o da al\\u00edquota (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN aliq_media_8m > 0 \\r\\n        THEN aliq_desvio_8m / NULLIF(aliq_media_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_coef_variacao_8m,\\r\\n    \\r\\n    -- Categoria de volatilidade\\r\\n    CASE\\r\\n        WHEN aliq_media_8m <= 0 OR aliq_desvio_8m IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.5 THEN 'ALTA'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.2 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade,\\r\\n    \\r\\n    -- Al\\u00edquota efetiva acumulada (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_total_8m > 0 \\r\\n        THEN icms_devido_total_8m / NULLIF(faturamento_total_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva_acumulada_8m,\\r\\n    \\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o do faturamento (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_medio_8m > 0 \\r\\n        THEN faturamento_desvio_8m / NULLIF(faturamento_medio_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS faturamento_coef_variacao_8m,\\r\\n    \\r\\n    -- Flag de diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN icms_recolher_total_8m > 100 AND valor_total_pago_8m = 0 THEN 1\\r\\n        WHEN icms_recolher_total_8m > 0 AND valor_total_pago_8m > 0\\r\\n            AND ABS(icms_recolher_total_8m - valor_total_pago_8m) / NULLIF(icms_recolher_total_8m, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento_8m,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM empresa_agg;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: DETEC\\u00c7\\u00c3O DE ANOMALIAS E ALERTAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. ANOMALIAS SETORIAIS\\r\\n-- Setores com comportamento an\\u00f4malo comparado \\u00e0 economia geral\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_anomalias_setoriais;\\r\\nCREATE TABLE niat.argos_anomalias_setoriais STORED AS PARQUET AS\\r\\nWITH economia_geral AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_economia,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_desvio_economia\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT \\r\\n    b.nu_per_ref,\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.qtd_empresas_total,\\r\\n    b.faturamento_total,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor,\\r\\n    e.aliq_mediana_economia,\\r\\n    \\r\\n    -- \\u00cdndice vs economia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.aliq_mediana_economia > 0 \\r\\n        THEN b.aliq_efetiva_mediana / NULLIF(e.aliq_mediana_economia, 0)\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_economia,\\r\\n    \\r\\n    -- Tipo de anomalia\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 'ALTA_VOLATILIDADE_INTERNA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia) THEN 'ALIQUOTA_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'ALIQUOTA_ALTA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS tipo_anomalia,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.5 THEN 'ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) \\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALTA'\\r\\n        WHEN b.aliq_coef_variacao > 0.3 THEN 'MEDIA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Score de relev\\u00e2ncia (considera faturamento)\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 50 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 45 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 35 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        ELSE 10.0\\r\\n    END AS score_relevancia,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nINNER JOIN economia_geral e ON b.nu_per_ref = e.nu_per_ref\\r\\nWHERE \\r\\n    b.aliq_coef_variacao > 0.3\\r\\n    OR b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n    OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia);\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. ALERTAS INDIVIDUAIS DE EMPRESAS\\r\\n-- Empresas com comportamento fora do padr\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_alertas_empresas;\\r\\nCREATE TABLE niat.argos_alertas_empresas STORED AS PARQUET AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Tipo de alerta\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'ALIQUOTA_MUITO_ABAIXO_SETOR'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'DIVERGENCIA_ICMS_PAGAMENTO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTA_VOLATILIDADE_TEMPORAL'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'ALIQUOTA_ABAIXO_SETOR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'CRITICO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 'CRITICO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'MEDIO'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'MEDIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Detalhes\\r\\n    evb.aliq_efetiva_empresa,\\r\\n    evb.aliq_setor_mediana,\\r\\n    evb.aliq_porte_mediana,\\r\\n    evb.indice_vs_mediana_setor,\\r\\n    evb.vl_faturamento,\\r\\n    evb.icms_devido,\\r\\n    evb.icms_recolher,\\r\\n    evb.valor_total_pago,\\r\\n    ete.aliq_coef_variacao_8m,\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Score de risco ponderado por faturamento\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 50 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 45 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 40 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 30 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        ELSE 15.0\\r\\n    END AS score_risco,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE \\r\\n    evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n    OR evb.flag_divergencia_pagamento = 1\\r\\n    OR ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: VIEWS PARA PYTHON/STREAMLIT\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. DASHBOARD DE SETORES\\r\\n-- Vis\\u00e3o consolidada dos setores para an\\u00e1lises Python\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_setores;\\r\\nCREATE VIEW niat.vw_dashboard_setores AS\\r\\nSELECT \\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- Quantidades\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Valores financeiros (formatados para BR)\\r\\n    REPLACE(CAST(b.faturamento_total / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    REPLACE(CAST(b.icms_devido_total / 1000000 AS STRING), '.', ',') AS icms_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_media * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p25 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p25_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p75 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p75_pct,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    REPLACE(CAST(ROUND(b.aliq_coef_variacao, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    \\r\\n    -- Dados de evolu\\u00e7\\u00e3o temporal (quando dispon\\u00edvel)\\r\\n    et.categoria_volatilidade_temporal,\\r\\n    et.tendencia_aliquota,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    \\r\\n    -- Flags de anomalias\\r\\n    CASE WHEN a.cnae_classe IS NOT NULL THEN 1 ELSE 0 END AS flag_anomalia,\\r\\n    a.tipo_anomalia,\\r\\n    a.severidade AS severidade_anomalia\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor et ON b.cnae_classe = et.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais a ON \\r\\n    b.cnae_classe = a.cnae_classe AND b.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. DASHBOARD DE EMPRESAS\\r\\n-- Dados individuais com compara\\u00e7\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_empresas;\\r\\nCREATE VIEW niat.vw_dashboard_empresas AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores financeiros (formatados)\\r\\n    REPLACE(CAST(evb.vl_faturamento AS STRING), '.', ',') AS faturamento,\\r\\n    REPLACE(CAST(evb.icms_devido AS STRING), '.', ',') AS icms_devido,\\r\\n    REPLACE(CAST(evb.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(evb.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_efetiva_empresa * 100, 2) AS STRING), '.', ','), '%') AS aliq_empresa_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_setor_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_setor_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_porte_pct,\\r\\n    \\r\\n    -- \\u00cdndices\\r\\n    REPLACE(CAST(ROUND(evb.indice_vs_mediana_setor, 2) AS STRING), '.', ',') AS indice_vs_setor,\\r\\n    \\r\\n    -- Status\\r\\n    evb.status_vs_setor,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Dados temporais (8 meses)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao_8m,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade AS severidade_alerta,\\r\\n    REPLACE(CAST(ROUND(a.score_risco, 1) AS STRING), '.', ',') AS score_risco\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. AN\\u00c1LISE DE VOLATILIDADE\\r\\n-- Empresas e setores com alta volatilidade\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_analise_volatilidade;\\r\\nCREATE VIEW niat.vw_analise_volatilidade AS\\r\\nSELECT \\r\\n    'SETOR' AS tipo,\\r\\n    et.cnae_classe AS identificador,\\r\\n    et.desc_cnae_classe AS descricao,\\r\\n    et.categoria_volatilidade_temporal AS categoria,\\r\\n    REPLACE(CAST(ROUND(et.coef_variacao_temporal, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(et.faturamento_acumulado_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor et\\r\\nWHERE et.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EMPRESA' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(ete.faturamento_total_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. RELA\\u00c7\\u00c3O ICMS vs PAGAMENTOS\\r\\n-- An\\u00e1lise de diverg\\u00eancias entre ICMS devido e pagamentos\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_relacao_icms_pagamentos;\\r\\nCREATE VIEW niat.vw_relacao_icms_pagamentos AS\\r\\nSELECT \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Valores (formatados)\\r\\n    REPLACE(CAST(e.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(p.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    REPLACE(CAST(p.qtd_pagamentos AS STRING), '.', ',') AS qtd_pagamentos,\\r\\n    \\r\\n    -- Diverg\\u00eancia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n        THEN REPLACE(CAST(ROUND((e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1) AS STRING), '.', ',')\\r\\n        ELSE NULL \\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.1 THEN 'DIVERGENCIA_MEDIA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 THEN 'NORMAL'\\r\\n        ELSE 'SEM_DADOS'\\r\\n    END AS classificacao_divergencia\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n    e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nWHERE e.icms_recolher IS NOT NULL OR p.valor_total_pago IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Contagem de registros em todas as tabelas\\r\\nSELECT 'RESUMO DO SISTEMA V4.0' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_benchmark_setorial\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial_porte' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT porte_empresa) AS portes\\r\\nFROM niat.argos_benchmark_setorial_porte\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_empresas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_pagamentos_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    SUM(qtd_pagamentos) AS total_pagamentos\\r\\nFROM niat.argos_pagamentos_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresa_vs_benchmark' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores\\r\\nFROM niat.argos_empresa_vs_benchmark\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_setor' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_anomalias_setoriais' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_anomalos,\\r\\n    COUNT(DISTINCT tipo_anomalia) AS tipos\\r\\nFROM niat.argos_anomalias_setoriais\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_alertas_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_alerta,\\r\\n    COUNT(DISTINCT tipo_alerta) AS tipos\\r\\nFROM niat.argos_alertas_empresas;\\r\\n\\r\\n-- Distribui\\u00e7\\u00e3o de alertas\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    tipo_alerta,\\r\\n    severidade,\\r\\n    COUNT(*) AS quantidade,\\r\\n    REPLACE(CAST(ROUND(AVG(score_risco), 1) AS STRING), '.', ',') AS score_medio\\r\\nFROM niat.argos_alertas_empresas\\r\\nGROUP BY tipo_alerta, severidade\\r\\nORDER BY AVG(score_risco) DESC;\\r\\n\\r\\n-- Top 10 setores por faturamento\\r\\nSELECT \\r\\n    'TOP 10 SETORES POR FATURAMENTO' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    REPLACE(CAST(SUM(faturamento_total) / 1000000000 AS STRING), '.', ',') AS faturamento_bilhoes,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos,\\r\\n    CONCAT(REPLACE(CAST(ROUND(AVG(aliq_efetiva_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_media\\r\\nFROM niat.argos_benchmark_setorial\\r\\nGROUP BY cnae_classe, desc_cnae_classe\\r\\nORDER BY SUM(faturamento_total) DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DO SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA V4.0\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- PR\\u00d3XIMOS PASSOS SUGERIDOS PARA PYTHON/JUPYTER:\\r\\n-- \\r\\n-- 1. Importar as views principais:\\r\\n--    - niat.vw_dashboard_setores\\r\\n--    - niat.vw_dashboard_empresas\\r\\n--    - niat.vw_analise_volatilidade\\r\\n--    - niat.vw_relacao_icms_pagamentos\\r\\n--\\r\\n-- 2. Criar visualiza\\u00e7\\u00f5es no Streamlit:\\r\\n--    - Gr\\u00e1ficos de evolu\\u00e7\\u00e3o temporal por setor\\r\\n--    - Mapa de calor de al\\u00edquotas por CNAE\\r\\n--    - Distribui\\u00e7\\u00e3o de empresas por quartil de al\\u00edquota\\r\\n--    - An\\u00e1lise de diverg\\u00eancias ICMS vs pagamentos\\r\\n--    - Ranking de setores com anomalias\\r\\n--\\r\\n-- 3. An\\u00e1lises estat\\u00edsticas avan\\u00e7adas:\\r\\n--    - Clustering de setores similares\\r\\n--    - Detec\\u00e7\\u00e3o de outliers por setor\\r\\n--    - Previs\\u00e3o de tend\\u00eancias de al\\u00edquotas\\r\\n--    - An\\u00e1lise de correla\\u00e7\\u00e3o entre vari\\u00e1veis\\r\\n--\\r\\n-- ============================================================================\", \"result\": {\"id\": \"b1acb8c8-042a-27bc-2c13-284b036b04db\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"has_more_statements\": true, \"statement_id\": 31, \"statements_count\": 33, \"previous_statement_hash\": \"3245ec3dd146ccba53157fe46bf6efe6ffa4329f5de0a512a7ff2414\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 31, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 33, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-02T20:38:45.896Z\", \"endTime\": \"2025-10-02T20:38:45.896Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 7608, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"cnae_classe\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"periodos\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759437525879, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ============================================================================\\r\\n-- SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA - VERS\\u00c3O 4.0\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- Dados do per\\u00edodo: Janeiro/2025 a Agosto/2025 (202501 a 202508)\\r\\n-- ============================================================================\\r\\n-- OBJETIVO:\\r\\n-- An\\u00e1lise setorial profunda para identificar padr\\u00f5es, anomalias e criar \\r\\n-- benchmarks tribut\\u00e1rios. Foco em compara\\u00e7\\u00e3o empresa vs setor sem marca\\u00e7\\u00e3o\\r\\n-- de empresas fiscalizadas.\\r\\n--\\r\\n-- PRINCIPAIS FUNCIONALIDADES:\\r\\n-- 1. Benchmarks setoriais por CNAE (m\\u00e9dia, mediana, percentis, volatilidade)\\r\\n-- 2. An\\u00e1lise granular por porte empresarial dentro de cada setor\\r\\n-- 3. Evolu\\u00e7\\u00e3o temporal de setores e empresas (tend\\u00eancias)\\r\\n-- 4. Detec\\u00e7\\u00e3o de anomalias setoriais e alertas individuais\\r\\n-- 5. An\\u00e1lise de pagamentos vs ICMS devido\\r\\n-- 6. Prepara\\u00e7\\u00e3o de dados para Python/Jupyter/Streamlit\\r\\n-- ============================================================================\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS CORE (FUNDA\\u00c7\\u00c3O DO SISTEMA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. BENCHMARK SETORIAL MENSAL\\r\\n-- Agrega\\u00e7\\u00e3o mensal por CNAE com todas as m\\u00e9tricas estat\\u00edsticas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial;\\r\\nCREATE TABLE niat.argos_benchmark_setorial STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n\\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT d.nu_cnpj) AS qtd_empresas_total,\\r\\n    COUNT(DISTINCT CASE WHEN d.sn_com_movimento = 1 THEN d.nu_cnpj END) AS qtd_empresas_ativas,\\r\\n    COUNT(DISTINCT CASE WHEN d.vl_faturamento > 1000 THEN d.nu_cnpj END) AS qtd_empresas_relevantes,\\r\\n\\r\\n    -- Agregados financeiros (valores brutos para c\\u00e1lculos)\\r\\n    SUM(COALESCE(d.vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(d.vl_receita_bruta, 0)) AS receita_bruta_total,\\r\\n    SUM(COALESCE(d.vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    SUM(COALESCE(d.vl_deb_recolher, 0)) AS icms_recolher_total,\\r\\n    AVG(d.vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva: Estat\\u00edsticas Descritivas (apenas empresas com fat > 1000)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    MIN(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_min,\\r\\n    \\r\\n    MAX(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_max,\\r\\n    \\r\\n    -- Aproxima\\u00e7\\u00f5es de percentis (mediana \\u2248 m\\u00e9dia, P25/P75 usando desvio)\\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) - \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p25,\\r\\n    \\r\\n    AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) + \\r\\n    (STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n        THEN d.vl_tot_deb / d.vl_faturamento END) * 0.5) AS aliq_efetiva_p75,\\r\\n\\r\\n    -- Coeficiente de Varia\\u00e7\\u00e3o Setorial\\r\\n    CASE \\r\\n        WHEN AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) > 0\\r\\n        THEN STDDEV(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END) / \\r\\n             AVG(CASE WHEN d.sn_com_movimento = 1 AND d.vl_faturamento > 1000 \\r\\n            THEN d.vl_tot_deb / d.vl_faturamento END)\\r\\n        ELSE NULL\\r\\n    END AS aliq_coef_variacao,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL\\r\\n    AND SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) IN (\\r\\n        '10','11','12','13','14','15','16','17','18','19',\\r\\n        '20','21','22','23','24','25','26','27','28','29',\\r\\n        '30','31','32','33','35','41','42','43','45','46','47'\\r\\n    )\\r\\nGROUP BY \\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5),\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe,\\r\\n    c.cd_secao,\\r\\n    c.de_secao\\r\\nHAVING \\r\\n    COUNT(DISTINCT d.nu_cnpj) >= 5;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. BENCHMARK SETORIAL POR PORTE\\r\\n-- Estratifica\\u00e7\\u00e3o adicional por porte empresarial dentro de cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial_porte;\\r\\nCREATE TABLE niat.argos_benchmark_setorial_porte STORED AS PARQUET AS\\r\\nWITH empresas_com_porte AS (\\r\\n    SELECT \\r\\n        d.*,\\r\\n        c.cd_cnae,\\r\\n        c.de_classe,\\r\\n        c.cd_secao,\\r\\n        c.de_secao,\\r\\n        CASE\\r\\n            WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n            WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n            WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n            WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n            ELSE 'SEM_FATURAMENTO'\\r\\n        END AS porte_empresa\\r\\n    FROM usr_sat_ods.vw_ods_decl_dime d\\r\\n    INNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\n    WHERE \\r\\n        d.sn_cancelada = 0\\r\\n        AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n        AND c.cd_cnae IS NOT NULL\\r\\n)\\r\\nSELECT\\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    de_classe AS desc_cnae_classe,\\r\\n    porte_empresa,\\r\\n\\r\\n    -- Contagens por porte\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(DISTINCT CASE WHEN sn_com_movimento = 1 THEN nu_cnpj END) AS qtd_empresas_ativas,\\r\\n\\r\\n    -- Estat\\u00edsticas de al\\u00edquota por porte (com prote\\u00e7\\u00e3o contra divis\\u00e3o por zero)\\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_media,\\r\\n    \\r\\n    STDDEV(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_desvio,\\r\\n    \\r\\n    AVG(CASE WHEN sn_com_movimento = 1 AND vl_faturamento > 1000 AND vl_faturamento > 0\\r\\n        THEN vl_tot_deb / vl_faturamento END) AS aliq_efetiva_mediana,\\r\\n\\r\\n    -- Agregados financeiros\\r\\n    SUM(COALESCE(vl_faturamento, 0)) AS faturamento_total,\\r\\n    SUM(COALESCE(vl_tot_deb, 0)) AS icms_devido_total,\\r\\n    AVG(vl_faturamento) AS faturamento_medio,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM empresas_com_porte\\r\\nWHERE porte_empresa != 'SEM_FATURAMENTO'\\r\\nGROUP BY \\r\\n    nu_ano_ref,\\r\\n    nu_per_ref,\\r\\n    SUBSTR(CAST(cd_cnae AS STRING), 1, 5),\\r\\n    de_classe,\\r\\n    porte_empresa\\r\\nHAVING \\r\\n    COUNT(DISTINCT nu_cnpj) >= 3;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. DADOS INDIVIDUAIS DAS EMPRESAS\\r\\n-- Informa\\u00e7\\u00f5es mensais de cada empresa com porte e al\\u00edquotas\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresas;\\r\\nCREATE TABLE niat.argos_empresas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae_classe,\\r\\n    c.cd_secao AS secao,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Per\\u00edodo\\r\\n    d.nu_ano_ref,\\r\\n    d.nu_per_ref,\\r\\n    \\r\\n    -- Status da declara\\u00e7\\u00e3o\\r\\n    d.sn_omisso,\\r\\n    d.sn_entregue_prazo,\\r\\n    d.sn_com_movimento,\\r\\n    d.dt_entrega,\\r\\n    d.qt_funcionarios,\\r\\n\\r\\n    -- Porte Empresarial\\r\\n    CASE\\r\\n        WHEN d.vl_faturamento <= 30000 THEN 'MICRO'\\r\\n        WHEN d.vl_faturamento > 30000 AND d.vl_faturamento <= 400000 THEN 'PEQUENO'\\r\\n        WHEN d.vl_faturamento > 400000 AND d.vl_faturamento <= 5000000 THEN 'MEDIO'\\r\\n        WHEN d.vl_faturamento > 5000000 THEN 'GRANDE'\\r\\n        ELSE 'SEM_FATURAMENTO'\\r\\n    END AS porte_empresa,\\r\\n\\r\\n    -- Valores financeiros\\r\\n    d.vl_faturamento,\\r\\n    d.vl_receita_bruta,\\r\\n    d.vl_tot_deb AS icms_devido,\\r\\n    d.vl_deb_recolher AS icms_recolher,\\r\\n    d.vl_tot_sai_bc AS bc_saidas,\\r\\n    d.vl_tot_sai_imposto_creditado AS icms_destacado_saidas,\\r\\n    d.vl_tot_ent_bc AS bc_entradas,\\r\\n    d.vl_tot_ent_imposto_creditado AS icms_creditado_entradas,\\r\\n\\r\\n    -- Al\\u00edquota Efetiva (apenas se faturamento > 1000, com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_faturamento > 1000 AND d.vl_faturamento > 0\\r\\n        THEN d.vl_tot_deb / d.vl_faturamento \\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva,\\r\\n\\r\\n    -- Al\\u00edquota Destacada nas Sa\\u00eddas (com prote\\u00e7\\u00e3o contra zero)\\r\\n    CASE \\r\\n        WHEN d.vl_tot_sai_bc > 0 \\r\\n        THEN d.vl_tot_sai_imposto_creditado / d.vl_tot_sai_bc \\r\\n        ELSE NULL \\r\\n    END AS aliq_destacada_saidas,\\r\\n\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM usr_sat_ods.vw_ods_decl_dime d\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON d.nu_ie = c.nu_ie\\r\\nWHERE \\r\\n    d.sn_cancelada = 0\\r\\n    AND d.nu_per_ref BETWEEN 202501 AND 202508\\r\\n    AND c.cd_cnae IS NOT NULL;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.4. PAGAMENTOS POR EMPRESA (MENSAL)\\r\\n-- Agrega\\u00e7\\u00e3o mensal dos pagamentos de ICMS\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_pagamentos_empresa;\\r\\nCREATE TABLE niat.argos_pagamentos_empresa STORED AS PARQUET AS\\r\\nWITH \\r\\ncnpjs_periodos AS (\\r\\n    SELECT DISTINCT nu_cnpj, nu_per_ref\\r\\n    FROM niat.argos_empresas\\r\\n),\\r\\npagamentos_agg AS (\\r\\n    SELECT \\r\\n        nu_cnpj, \\r\\n        nu_per_pagamento,\\r\\n        COUNT(nu_id_pagamento) AS qtd_pagamentos, \\r\\n        SUM(vl_total) AS valor_total_pago\\r\\n    FROM usr_sat_ods.vw_ods_pagamento\\r\\n    WHERE nu_per_pagamento BETWEEN 202501 AND 202508\\r\\n      AND cd_receita IN (1449, 1465, 1473, 1554, 1570, 1589, 1597, 1600, 1643, \\r\\n                         1651, 1716, 1724, 1732, 1740, 1759, 1767, 1783, 1791, \\r\\n                         2140, 2496, 2526, 2534, 3000, 3050, 3662, 4383, 7110, \\r\\n                         7137, 9687, 9784)\\r\\n    GROUP BY nu_cnpj, nu_per_pagamento\\r\\n)\\r\\nSELECT \\r\\n    c.nu_cnpj,\\r\\n    c.nu_per_ref,\\r\\n    COALESCE(p.qtd_pagamentos, 0) AS qtd_pagamentos,\\r\\n    COALESCE(p.valor_total_pago, 0) AS valor_total_pago,\\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM cnpjs_periodos c\\r\\nLEFT JOIN pagamentos_agg p ON c.nu_cnpj = p.nu_cnpj AND c.nu_per_ref = p.nu_per_pagamento;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.5. COMPARA\\u00c7\\u00c3O EMPRESA VS BENCHMARK SETORIAL\\r\\n-- Cruzamento dos dados individuais com benchmarks do setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_empresa_vs_benchmark;\\r\\nCREATE TABLE niat.argos_empresa_vs_benchmark STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o da empresa\\r\\n    e.nu_cnpj,\\r\\n    e.nu_ie,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.cnae_divisao,\\r\\n    e.desc_cnae_classe,\\r\\n    e.secao,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Dados da empresa\\r\\n    e.vl_faturamento,\\r\\n    e.icms_devido,\\r\\n    e.icms_recolher,\\r\\n    e.aliq_efetiva AS aliq_efetiva_empresa,\\r\\n    e.sn_com_movimento,\\r\\n    e.sn_entregue_prazo,\\r\\n    e.sn_omisso,\\r\\n    \\r\\n    -- Benchmarks do setor (geral)\\r\\n    b.qtd_empresas_total AS empresas_no_setor,\\r\\n    b.aliq_efetiva_media AS aliq_setor_media,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor_mediana,\\r\\n    b.aliq_efetiva_p25 AS aliq_setor_p25,\\r\\n    b.aliq_efetiva_p75 AS aliq_setor_p75,\\r\\n    b.aliq_efetiva_desvio AS aliq_setor_desvio,\\r\\n    b.aliq_coef_variacao AS aliq_setor_coef_variacao,\\r\\n    \\r\\n    -- Benchmarks do setor por porte (quando dispon\\u00edvel)\\r\\n    bp.qtd_empresas AS empresas_mesmo_porte,\\r\\n    bp.aliq_efetiva_media AS aliq_porte_media,\\r\\n    bp.aliq_efetiva_mediana AS aliq_porte_mediana,\\r\\n    bp.aliq_efetiva_desvio AS aliq_porte_desvio,\\r\\n    \\r\\n    -- Dados de pagamento\\r\\n    p.qtd_pagamentos,\\r\\n    p.valor_total_pago,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs setor geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN b.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / b.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_setor,\\r\\n    \\r\\n    -- \\u00cdndices comparativos vs mesmo porte (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN bp.aliq_efetiva_mediana > 0 AND e.aliq_efetiva IS NOT NULL\\r\\n        THEN e.aliq_efetiva / bp.aliq_efetiva_mediana\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_mediana_porte,\\r\\n    \\r\\n    -- Status comparativo (baseado em desvios padr\\u00e3o da mediana setorial)\\r\\n    CASE \\r\\n        WHEN e.aliq_efetiva IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN b.aliq_efetiva_desvio IS NULL OR b.aliq_efetiva_desvio = 0 THEN 'NORMAL'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ABAIXO'\\r\\n        WHEN e.aliq_efetiva < (b.aliq_efetiva_mediana - b.aliq_efetiva_desvio) THEN 'ABAIXO'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + 2 * b.aliq_efetiva_desvio) THEN 'MUITO_ACIMA'\\r\\n        WHEN e.aliq_efetiva > (b.aliq_efetiva_mediana + b.aliq_efetiva_desvio) THEN 'ACIMA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS status_vs_setor,\\r\\n    \\r\\n    -- Diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 1\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nINNER JOIN niat.argos_benchmark_setorial b ON \\r\\n    e.cnae_classe = b.cnae_classe \\r\\n    AND e.nu_per_ref = b.nu_per_ref\\r\\nLEFT JOIN niat.argos_benchmark_setorial_porte bp ON\\r\\n    e.cnae_classe = bp.cnae_classe\\r\\n    AND e.nu_per_ref = bp.nu_per_ref\\r\\n    AND e.porte_empresa = bp.porte_empresa\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON\\r\\n    e.nu_cnpj = p.nu_cnpj\\r\\n    AND e.nu_per_ref = p.nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISES TEMPORAIS E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. EVOLU\\u00c7\\u00c3O TEMPORAL SETORIAL\\r\\n-- Tend\\u00eancias de 8 meses para cada setor\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_setor;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_setor STORED AS PARQUET AS\\r\\nWITH setor_mensal AS (\\r\\n    SELECT \\r\\n        cnae_classe,\\r\\n        desc_cnae_classe,\\r\\n        secao,\\r\\n        desc_secao,\\r\\n        nu_per_ref,\\r\\n        aliq_efetiva_mediana,\\r\\n        faturamento_total,\\r\\n        icms_devido_total,\\r\\n        qtd_empresas_total\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n),\\r\\nsetor_agregado AS (\\r\\n    SELECT\\r\\n        cnae_classe,\\r\\n        MAX(desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(secao) AS secao,\\r\\n        MAX(desc_secao) AS desc_secao,\\r\\n        \\r\\n        -- Contagens\\r\\n        COUNT(DISTINCT nu_per_ref) AS meses_analisados,\\r\\n        AVG(qtd_empresas_total) AS media_empresas_mes,\\r\\n        \\r\\n        -- M\\u00e9dias temporais\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_media_8m,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_mediana_desvio_8m,\\r\\n        MIN(aliq_efetiva_mediana) AS aliq_mediana_min_8m,\\r\\n        MAX(aliq_efetiva_mediana) AS aliq_mediana_max_8m,\\r\\n        \\r\\n        -- Coeficiente de varia\\u00e7\\u00e3o temporal\\r\\n        CASE \\r\\n            WHEN AVG(aliq_efetiva_mediana) > 0 \\r\\n            THEN STDDEV(aliq_efetiva_mediana) / AVG(aliq_efetiva_mediana)\\r\\n            ELSE NULL \\r\\n        END AS coef_variacao_temporal,\\r\\n        \\r\\n        -- Totais acumulados\\r\\n        SUM(faturamento_total) AS faturamento_acumulado_8m,\\r\\n        SUM(icms_devido_total) AS icms_devido_acumulado_8m,\\r\\n        \\r\\n        -- Al\\u00edquota efetiva acumulada\\r\\n        CASE \\r\\n            WHEN SUM(faturamento_total) > 0 \\r\\n            THEN SUM(icms_devido_total) / SUM(faturamento_total)\\r\\n            ELSE NULL \\r\\n        END AS aliq_efetiva_acumulada_8m,\\r\\n        \\r\\n        -- Tend\\u00eancia simples (compara\\u00e7\\u00e3o primeiro vs \\u00faltimo trimestre)\\r\\n        AVG(CASE WHEN nu_per_ref IN (202501, 202502, 202503) THEN aliq_efetiva_mediana END) AS aliq_media_trim1,\\r\\n        AVG(CASE WHEN nu_per_ref IN (202506, 202507, 202508) THEN aliq_efetiva_mediana END) AS aliq_media_trim3\\r\\n        \\r\\n    FROM setor_mensal\\r\\n    GROUP BY cnae_classe\\r\\n    HAVING COUNT(DISTINCT nu_per_ref) >= 6\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Classifica\\u00e7\\u00e3o de volatilidade temporal\\r\\n    CASE\\r\\n        WHEN coef_variacao_temporal IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN coef_variacao_temporal > 0.3 THEN 'ALTA'\\r\\n        WHEN coef_variacao_temporal > 0.15 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade_temporal,\\r\\n    \\r\\n    -- Tend\\u00eancia geral (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN aliq_media_trim1 IS NULL OR aliq_media_trim3 IS NULL OR aliq_media_trim1 = 0 THEN 'INDETERMINADA'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) > 0.1 THEN 'CRESCENTE'\\r\\n        WHEN (aliq_media_trim3 - aliq_media_trim1) / NULLIF(aliq_media_trim1, 0) < -0.1 THEN 'DECRESCENTE'\\r\\n        ELSE 'ESTAVEL'\\r\\n    END AS tendencia_aliquota,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM setor_agregado;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. EVOLU\\u00c7\\u00c3O TEMPORAL POR EMPRESA\\r\\n-- Hist\\u00f3rico de 8 meses para cada empresa\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_evolucao_temporal_empresa;\\r\\nCREATE TABLE niat.argos_evolucao_temporal_empresa STORED AS PARQUET AS\\r\\nWITH empresa_agg AS (\\r\\n    SELECT \\r\\n        e.nu_cnpj,\\r\\n        MAX(e.nm_razao_social) AS nm_razao_social,\\r\\n        e.cnae_classe,\\r\\n        MAX(e.desc_cnae_classe) AS desc_cnae_classe,\\r\\n        MAX(e.porte_empresa) AS porte_predominante,\\r\\n        \\r\\n        -- Contagens temporais\\r\\n        COUNT(*) AS meses_com_declaracao,\\r\\n        COUNT(CASE WHEN e.sn_com_movimento = 1 THEN 1 END) AS meses_com_movimento,\\r\\n        COUNT(CASE WHEN e.sn_omisso = 1 THEN 1 END) AS meses_omisso,\\r\\n        \\r\\n        -- Agregados financeiros\\r\\n        SUM(e.vl_faturamento) AS faturamento_total_8m,\\r\\n        SUM(e.icms_devido) AS icms_devido_total_8m,\\r\\n        SUM(e.icms_recolher) AS icms_recolher_total_8m,\\r\\n        AVG(e.vl_faturamento) AS faturamento_medio_8m,\\r\\n        STDDEV(e.vl_faturamento) AS faturamento_desvio_8m,\\r\\n        \\r\\n        -- Estat\\u00edsticas de al\\u00edquota\\r\\n        AVG(e.aliq_efetiva) AS aliq_media_8m,\\r\\n        STDDEV(e.aliq_efetiva) AS aliq_desvio_8m,\\r\\n        MIN(e.aliq_efetiva) AS aliq_min_8m,\\r\\n        MAX(e.aliq_efetiva) AS aliq_max_8m,\\r\\n        \\r\\n        -- Agregados de pagamentos\\r\\n        SUM(p.qtd_pagamentos) AS qtd_pagamentos_total_8m,\\r\\n        SUM(p.valor_total_pago) AS valor_total_pago_8m\\r\\n        \\r\\n    FROM niat.argos_empresas e\\r\\n    LEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n        e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\n    WHERE e.aliq_efetiva IS NOT NULL\\r\\n    GROUP BY e.nu_cnpj, e.cnae_classe\\r\\n    HAVING COUNT(*) >= 3\\r\\n)\\r\\nSELECT \\r\\n    *,\\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o da al\\u00edquota (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN aliq_media_8m > 0 \\r\\n        THEN aliq_desvio_8m / NULLIF(aliq_media_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_coef_variacao_8m,\\r\\n    \\r\\n    -- Categoria de volatilidade\\r\\n    CASE\\r\\n        WHEN aliq_media_8m <= 0 OR aliq_desvio_8m IS NULL THEN 'SEM_DADOS'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.5 THEN 'ALTA'\\r\\n        WHEN (aliq_desvio_8m / NULLIF(aliq_media_8m, 0)) > 0.2 THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS categoria_volatilidade,\\r\\n    \\r\\n    -- Al\\u00edquota efetiva acumulada (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_total_8m > 0 \\r\\n        THEN icms_devido_total_8m / NULLIF(faturamento_total_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS aliq_efetiva_acumulada_8m,\\r\\n    \\r\\n    -- Coeficiente de varia\\u00e7\\u00e3o do faturamento (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN faturamento_medio_8m > 0 \\r\\n        THEN faturamento_desvio_8m / NULLIF(faturamento_medio_8m, 0)\\r\\n        ELSE NULL \\r\\n    END AS faturamento_coef_variacao_8m,\\r\\n    \\r\\n    -- Flag de diverg\\u00eancia entre ICMS e pagamentos (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN icms_recolher_total_8m > 100 AND valor_total_pago_8m = 0 THEN 1\\r\\n        WHEN icms_recolher_total_8m > 0 AND valor_total_pago_8m > 0\\r\\n            AND ABS(icms_recolher_total_8m - valor_total_pago_8m) / NULLIF(icms_recolher_total_8m, 0) > 0.3 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_divergencia_pagamento_8m,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\nFROM empresa_agg;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: DETEC\\u00c7\\u00c3O DE ANOMALIAS E ALERTAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. ANOMALIAS SETORIAIS\\r\\n-- Setores com comportamento an\\u00f4malo comparado \\u00e0 economia geral\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_anomalias_setoriais;\\r\\nCREATE TABLE niat.argos_anomalias_setoriais STORED AS PARQUET AS\\r\\nWITH economia_geral AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        AVG(aliq_efetiva_mediana) AS aliq_mediana_economia,\\r\\n        STDDEV(aliq_efetiva_mediana) AS aliq_desvio_economia\\r\\n    FROM niat.argos_benchmark_setorial\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT \\r\\n    b.nu_per_ref,\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.qtd_empresas_total,\\r\\n    b.faturamento_total,\\r\\n    b.aliq_efetiva_mediana AS aliq_setor,\\r\\n    e.aliq_mediana_economia,\\r\\n    \\r\\n    -- \\u00cdndice vs economia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.aliq_mediana_economia > 0 \\r\\n        THEN b.aliq_efetiva_mediana / NULLIF(e.aliq_mediana_economia, 0)\\r\\n        ELSE NULL \\r\\n    END AS indice_vs_economia,\\r\\n    \\r\\n    -- Tipo de anomalia\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 'ALTA_VOLATILIDADE_INTERNA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALIQUOTA_MUITO_ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia) THEN 'ALIQUOTA_BAIXA'\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'ALIQUOTA_ALTA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS tipo_anomalia,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.5 THEN 'ALTA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) \\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 'ALTA'\\r\\n        WHEN b.aliq_coef_variacao > 0.3 THEN 'MEDIA'\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n            OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia) THEN 'MEDIA'\\r\\n        ELSE 'BAIXA'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Score de relev\\u00e2ncia (considera faturamento)\\r\\n    CASE \\r\\n        WHEN b.aliq_coef_variacao > 0.4 THEN 50 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana < (e.aliq_mediana_economia - 2 * e.aliq_desvio_economia) THEN 45 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        WHEN b.aliq_efetiva_mediana > (e.aliq_mediana_economia + 2 * e.aliq_desvio_economia) THEN 35 * (1 + LN(CAST(1 + b.faturamento_total/1000000000 AS DOUBLE)))\\r\\n        ELSE 10.0\\r\\n    END AS score_relevancia,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nINNER JOIN economia_geral e ON b.nu_per_ref = e.nu_per_ref\\r\\nWHERE \\r\\n    b.aliq_coef_variacao > 0.3\\r\\n    OR b.aliq_efetiva_mediana < (e.aliq_mediana_economia - e.aliq_desvio_economia)\\r\\n    OR b.aliq_efetiva_mediana > (e.aliq_mediana_economia + e.aliq_desvio_economia);\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. ALERTAS INDIVIDUAIS DE EMPRESAS\\r\\n-- Empresas com comportamento fora do padr\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_alertas_empresas;\\r\\nCREATE TABLE niat.argos_alertas_empresas STORED AS PARQUET AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Tipo de alerta\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'ALIQUOTA_MUITO_ABAIXO_SETOR'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'DIVERGENCIA_ICMS_PAGAMENTO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTA_VOLATILIDADE_TEMPORAL'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'ALIQUOTA_ABAIXO_SETOR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Severidade\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 'CRITICO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 'CRITICO'\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 'ALTO'\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 'MEDIO'\\r\\n        WHEN evb.status_vs_setor = 'ABAIXO' THEN 'MEDIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS severidade,\\r\\n    \\r\\n    -- Detalhes\\r\\n    evb.aliq_efetiva_empresa,\\r\\n    evb.aliq_setor_mediana,\\r\\n    evb.aliq_porte_mediana,\\r\\n    evb.indice_vs_mediana_setor,\\r\\n    evb.vl_faturamento,\\r\\n    evb.icms_devido,\\r\\n    evb.icms_recolher,\\r\\n    evb.valor_total_pago,\\r\\n    ete.aliq_coef_variacao_8m,\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Score de risco ponderado por faturamento\\r\\n    CASE \\r\\n        WHEN evb.status_vs_setor = 'MUITO_ABAIXO' THEN 50 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 AND evb.icms_recolher > 10000 THEN 45 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN ete.categoria_volatilidade = 'ALTA' THEN 40 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        WHEN evb.flag_divergencia_pagamento = 1 THEN 30 * (1 + LN(CAST(1 + COALESCE(evb.vl_faturamento, 0)/1000000 AS DOUBLE)))\\r\\n        ELSE 15.0\\r\\n    END AS score_risco,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_criacao\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE \\r\\n    evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n    OR evb.flag_divergencia_pagamento = 1\\r\\n    OR ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: VIEWS PARA PYTHON/STREAMLIT\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. DASHBOARD DE SETORES\\r\\n-- Vis\\u00e3o consolidada dos setores para an\\u00e1lises Python\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_setores;\\r\\nCREATE VIEW niat.vw_dashboard_setores AS\\r\\nSELECT \\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- Quantidades\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Valores financeiros (formatados para BR)\\r\\n    REPLACE(CAST(b.faturamento_total / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    REPLACE(CAST(b.icms_devido_total / 1000000 AS STRING), '.', ',') AS icms_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_media * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p25 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p25_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(b.aliq_efetiva_p75 * 100, 2) AS STRING), '.', ','), '%') AS aliq_p75_pct,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    REPLACE(CAST(ROUND(b.aliq_coef_variacao, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    \\r\\n    -- Dados de evolu\\u00e7\\u00e3o temporal (quando dispon\\u00edvel)\\r\\n    et.categoria_volatilidade_temporal,\\r\\n    et.tendencia_aliquota,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    \\r\\n    -- Flags de anomalias\\r\\n    CASE WHEN a.cnae_classe IS NOT NULL THEN 1 ELSE 0 END AS flag_anomalia,\\r\\n    a.tipo_anomalia,\\r\\n    a.severidade AS severidade_anomalia\\r\\n\\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor et ON b.cnae_classe = et.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais a ON \\r\\n    b.cnae_classe = a.cnae_classe AND b.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. DASHBOARD DE EMPRESAS\\r\\n-- Dados individuais com compara\\u00e7\\u00e3o setorial\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_dashboard_empresas;\\r\\nCREATE VIEW niat.vw_dashboard_empresas AS\\r\\nSELECT \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.nu_per_ref,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores financeiros (formatados)\\r\\n    REPLACE(CAST(evb.vl_faturamento AS STRING), '.', ',') AS faturamento,\\r\\n    REPLACE(CAST(evb.icms_devido AS STRING), '.', ',') AS icms_devido,\\r\\n    REPLACE(CAST(evb.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(evb.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    \\r\\n    -- Al\\u00edquotas (formatadas como percentual)\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_efetiva_empresa * 100, 2) AS STRING), '.', ','), '%') AS aliq_empresa_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(evb.aliq_setor_mediana * 100, 2) AS STRING), '.', ','), '%') AS aliq_setor_pct,\\r\\n    CONCAT(REPLACE(CAST(ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_porte_pct,\\r\\n    \\r\\n    -- \\u00cdndices\\r\\n    REPLACE(CAST(ROUND(evb.indice_vs_mediana_setor, 2) AS STRING), '.', ',') AS indice_vs_setor,\\r\\n    \\r\\n    -- Status\\r\\n    evb.status_vs_setor,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Dados temporais (8 meses)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media_8m_pct,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao_8m,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade AS severidade_alerta,\\r\\n    REPLACE(CAST(ROUND(a.score_risco, 1) AS STRING), '.', ',') AS score_risco\\r\\n\\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. AN\\u00c1LISE DE VOLATILIDADE\\r\\n-- Empresas e setores com alta volatilidade\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_analise_volatilidade;\\r\\nCREATE VIEW niat.vw_analise_volatilidade AS\\r\\nSELECT \\r\\n    'SETOR' AS tipo,\\r\\n    et.cnae_classe AS identificador,\\r\\n    et.desc_cnae_classe AS descricao,\\r\\n    et.categoria_volatilidade_temporal AS categoria,\\r\\n    REPLACE(CAST(ROUND(et.coef_variacao_temporal, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(et.aliq_mediana_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(et.faturamento_acumulado_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor et\\r\\nWHERE et.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EMPRESA' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    REPLACE(CAST(ROUND(ete.aliq_coef_variacao_8m, 3) AS STRING), '.', ',') AS coef_variacao,\\r\\n    CONCAT(REPLACE(CAST(ROUND(ete.aliq_media_8m * 100, 2) AS STRING), '.', ','), '%') AS aliq_media,\\r\\n    REPLACE(CAST(ete.faturamento_total_8m / 1000000 AS STRING), '.', ',') AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. RELA\\u00c7\\u00c3O ICMS vs PAGAMENTOS\\r\\n-- An\\u00e1lise de diverg\\u00eancias entre ICMS devido e pagamentos\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.vw_relacao_icms_pagamentos;\\r\\nCREATE VIEW niat.vw_relacao_icms_pagamentos AS\\r\\nSELECT \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.nu_per_ref,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    \\r\\n    -- Valores (formatados)\\r\\n    REPLACE(CAST(e.icms_recolher AS STRING), '.', ',') AS icms_recolher,\\r\\n    REPLACE(CAST(p.valor_total_pago AS STRING), '.', ',') AS valor_pago,\\r\\n    REPLACE(CAST(p.qtd_pagamentos AS STRING), '.', ',') AS qtd_pagamentos,\\r\\n    \\r\\n    -- Diverg\\u00eancia (com prote\\u00e7\\u00e3o)\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n        THEN REPLACE(CAST(ROUND((e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1) AS STRING), '.', ',')\\r\\n        ELSE NULL \\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o (com prote\\u00e7\\u00e3o)\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 \\r\\n            AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.1 THEN 'DIVERGENCIA_MEDIA'\\r\\n        WHEN e.icms_recolher > 0 AND p.valor_total_pago > 0 THEN 'NORMAL'\\r\\n        ELSE 'SEM_DADOS'\\r\\n    END AS classificacao_divergencia\\r\\n\\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON \\r\\n    e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nWHERE e.icms_recolher IS NOT NULL OR p.valor_total_pago IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Contagem de registros em todas as tabelas\\r\\nSELECT 'RESUMO DO SISTEMA V4.0' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_benchmark_setorial\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial_porte' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    COUNT(DISTINCT porte_empresa) AS portes\\r\\nFROM niat.argos_benchmark_setorial_porte\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos\\r\\nFROM niat.argos_empresas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_pagamentos_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    SUM(qtd_pagamentos) AS total_pagamentos\\r\\nFROM niat.argos_pagamentos_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresa_vs_benchmark' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores\\r\\nFROM niat.argos_empresa_vs_benchmark\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_setor' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas,\\r\\n    0 AS extra\\r\\nFROM niat.argos_evolucao_temporal_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_anomalias_setoriais' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_anomalos,\\r\\n    COUNT(DISTINCT tipo_anomalia) AS tipos\\r\\nFROM niat.argos_anomalias_setoriais\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_alertas_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_alerta,\\r\\n    COUNT(DISTINCT tipo_alerta) AS tipos\\r\\nFROM niat.argos_alertas_empresas;\\r\\n\\r\\n-- Distribui\\u00e7\\u00e3o de alertas\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    tipo_alerta,\\r\\n    severidade,\\r\\n    COUNT(*) AS quantidade,\\r\\n    REPLACE(CAST(ROUND(AVG(score_risco), 1) AS STRING), '.', ',') AS score_medio\\r\\nFROM niat.argos_alertas_empresas\\r\\nGROUP BY tipo_alerta, severidade\\r\\nORDER BY AVG(score_risco) DESC;\\r\\n\\r\\n-- Top 10 setores por faturamento\\r\\nSELECT \\r\\n    'TOP 10 SETORES POR FATURAMENTO' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    REPLACE(CAST(SUM(faturamento_total) / 1000000000 AS STRING), '.', ',') AS faturamento_bilhoes,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos,\\r\\n    CONCAT(REPLACE(CAST(ROUND(AVG(aliq_efetiva_mediana) * 100, 2) AS STRING), '.', ','), '%') AS aliq_mediana_media\\r\\nFROM niat.argos_benchmark_setorial\\r\\nGROUP BY cnae_classe, desc_cnae_classe\\r\\nORDER BY SUM(faturamento_total) DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DO SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA V4.0\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- PR\\u00d3XIMOS PASSOS SUGERIDOS PARA PYTHON/JUPYTER:\\r\\n-- \\r\\n-- 1. Importar as views principais:\\r\\n--    - niat.vw_dashboard_setores\\r\\n--    - niat.vw_dashboard_empresas\\r\\n--    - niat.vw_analise_volatilidade\\r\\n--    - niat.vw_relacao_icms_pagamentos\\r\\n--\\r\\n-- 2. Criar visualiza\\u00e7\\u00f5es no Streamlit:\\r\\n--    - Gr\\u00e1ficos de evolu\\u00e7\\u00e3o temporal por setor\\r\\n--    - Mapa de calor de al\\u00edquotas por CNAE\\r\\n--    - Distribui\\u00e7\\u00e3o de empresas por quartil de al\\u00edquota\\r\\n--    - An\\u00e1lise de diverg\\u00eancias ICMS vs pagamentos\\r\\n--    - Ranking de setores com anomalias\\r\\n--\\r\\n-- 3. An\\u00e1lises estat\\u00edsticas avan\\u00e7adas:\\r\\n--    - Clustering de setores similares\\r\\n--    - Detec\\u00e7\\u00e3o de outliers por setor\\r\\n--    - Previs\\u00e3o de tend\\u00eancias de al\\u00edquotas\\r\\n--    - An\\u00e1lise de correla\\u00e7\\u00e3o entre vari\\u00e1veis\\r\\n--\\r\\n-- ============================================================================\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 997, \"column\": 79}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 4f4065be961f4f1f:5053ff0f00000000 100% Complete (7 out of 7)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"4f4065be961f4f1f:5053ff0f00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=4f4065be961f4f1f:5053ff0f00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 4f4065be961f4f1f:5053ff0f00000000 100% Complete (7 out of 7)\", \"progress\": 100, \"jobs\": [{\"name\": \"4f4065be961f4f1f:5053ff0f00000000\", \"url\": \"/hue/jobbrowser#!id=4f4065be961f4f1f:5053ff0f00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 13324.4, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 99, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SISTEMA DE INTELIGÊNCIA SETORIAL TRIBUTÁRIA - VERSÃO 4.0\r\n-- Receita Estadual de Santa Catarina\r\n-- Dados do período: Janeiro/2025 a Agosto/2025 (202501 a 202508)\r\n-- ============================================================================\r\n-- OBJETIVO:\r\n-- Análise setorial profunda para identificar padrões, anomalias e criar \r\n-- benchmarks tributários. Foco em comparação empresa vs setor sem marcação\r\n-- de empresas fiscalizadas.\r\n--\r\n-- PRINCIPAIS FUNCIONALIDADES:\r\n-- 1. Benchmarks setoriais por CNAE (média, mediana, percentis, volatilidade)\r\n-- 2. Análise granular por porte empresarial dentro de cada setor\r\n-- 3. Evolução temporal de setores e empresas (tendências)\r\n-- 4. Detecção de anomalias setoriais e alertas individuais\r\n-- 5. Análise de pagamentos vs ICMS devido\r\n-- 6. Preparação de dados para Python/Jupyter/Streamlit\r\n-- ============================================================================\r\n\r\n-- ============================================================================\r\n-- PARTE 1: TABELAS CORE (FUNDAÇÃO DO SISTEMA)\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 1.1. BENCHMARK SETORIAL MENSAL\r\n-- Agregação mensal por CNAE com todas as métricas estatísticas\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS niat.argos_benchmark_setorial;\r\nCREATE TABLE niat.argos_benchmark_setorial STORED AS PARQUET AS\r\nSELECT\r\n    -- Identificadores\r\n    d.nu_ano_ref,\r\n    d.nu_per_ref,\r\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\r\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\r\n    c.de_classe AS desc_cnae_classe,\r\n    c.cd_secao AS secao,\r\n    c.de_secao AS desc_secao,\r\n\r\n    -- Contagens\r\n    COUNT(DISTINCT d.nu_cnpj) AS qtd_empresas_total,\r\n    COUNT(DISTINCT CASE WHEN d.sn_",
    "last_modified": "2025-10-02T17:38:59.589",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a55ab5f4-6a18-484a-bf2b-fdbec7ccc1bd",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158926,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SETORES",
    "description": "",
    "uuid": "a55ab5f4-6a18-484a-bf2b-fdbec7ccc1bd",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-02T17:41:41.091",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158972,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SETORES: Analises",
    "description": "",
    "uuid": "c09fdf0f-7da6-e822-7d0d-f4823e48ffdb",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158972, \"uuid\": \"c09fdf0f-7da6-e822-7d0d-f4823e48ffdb\", \"name\": \"SETORES: Analises\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"92dcb347-7191-c08c-ebaa-d63dbbfd0501\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 823, \"column\": 79}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- CONSULTAS ANAL\\u00cdTICAS - SISTEMA DE INTELIG\\u00caNCIA SETORIAL TRIBUT\\u00c1RIA v4.0\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- ============================================================================\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 1: ESTAT\\u00cdSTICAS GERAIS DO SISTEMA (VIS\\u00c3O MACRO)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1. PANORAMA GERAL DO SISTEMA\\r\\n-- Objetivo: Obter vis\\u00e3o executiva completa do ambiente monitorado\\r\\nSELECT\\r\\n    '1.1. PANORAMA GERAL DO SISTEMA' AS consulta,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT b.cnae_classe) AS total_setores_monitorados,\\r\\n    COUNT(DISTINCT e.nu_cnpj) AS total_empresas_monitoradas,\\r\\n    COUNT(DISTINCT e.nu_per_ref) AS total_periodos_analisados,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Porte\\r\\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'MICRO' THEN e.nu_cnpj END) AS total_microempresas,\\r\\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'PEQUENO' THEN e.nu_cnpj END) AS total_pequenas,\\r\\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'MEDIO' THEN e.nu_cnpj END) AS total_medias,\\r\\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'GRANDE' THEN e.nu_cnpj END) AS total_grandes,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras Gerais\\r\\n    ROUND(SUM(e.vl_faturamento) / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(SUM(e.icms_devido) / 1000000000, 2) AS icms_devido_total_bilhoes,\\r\\n    ROUND(AVG(e.aliq_efetiva) * 100, 2) AS aliquota_media_sistema_pct,\\r\\n    \\r\\n    -- M\\u00e9tricas de Pagamentos\\r\\n    ROUND(SUM(p.valor_total_pago) / 1000000000, 2) AS pagamentos_total_bilhoes,\\r\\n    ROUND((SUM(e.icms_recolher) - SUM(p.valor_total_pago)) / 1000000, 2) AS diferenca_icms_pagto_milhoes,\\r\\n    \\r\\n    -- M\\u00e9tricas de Qualidade\\r\\n    COUNT(DISTINCT CASE WHEN e.sn_com_movimento = 1 THEN e.nu_cnpj END) AS empresas_ativas,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN e.sn_com_movimento = 1 THEN e.nu_cnpj END) * 100.0 / \\r\\n          COUNT(DISTINCT e.nu_cnpj), 2) AS perc_empresas_ativas,\\r\\n    \\r\\n    -- M\\u00e9tricas de Alertas\\r\\n    COUNT(DISTINCT a.nu_cnpj) AS empresas_com_alertas,\\r\\n    ROUND(COUNT(DISTINCT a.nu_cnpj) * 100.0 / COUNT(DISTINCT e.nu_cnpj), 2) AS perc_empresas_com_alertas,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\\r\\n    \\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_benchmark_setorial b ON e.cnae_classe = b.cnae_classe AND e.nu_per_ref = b.nu_per_ref\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON e.nu_cnpj = a.nu_cnpj AND e.nu_per_ref = a.nu_per_ref\\r\\nWHERE e.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresas);\\r\\n\\r\\n-- 1.2. DISTRIBUI\\u00c7\\u00c3O DE EMPRESAS POR PORTE E SETOR\\r\\n-- Objetivo: Entender a estrutura empresarial do sistema\\r\\nSELECT\\r\\n    '1.2. DISTRIBUI\\u00c7\\u00c3O POR PORTE E SETOR' AS consulta,\\r\\n    \\r\\n    e.porte_empresa,\\r\\n    COUNT(DISTINCT e.nu_cnpj) AS quantidade_empresas,\\r\\n    ROUND(COUNT(DISTINCT e.nu_cnpj) * 100.0 / SUM(COUNT(DISTINCT e.nu_cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras por Porte\\r\\n    ROUND(AVG(e.vl_faturamento), 2) AS faturamento_medio,\\r\\n    ROUND(SUM(e.vl_faturamento) / 1000000, 2) AS faturamento_total_milhoes,\\r\\n    ROUND(AVG(e.aliq_efetiva) * 100, 2) AS aliquota_media_pct,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de Alertas por Porte\\r\\n    COUNT(DISTINCT CASE WHEN a.nu_cnpj IS NOT NULL THEN e.nu_cnpj END) AS empresas_com_alertas,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN a.nu_cnpj IS NOT NULL THEN e.nu_cnpj END) * 100.0 / \\r\\n          COUNT(DISTINCT e.nu_cnpj), 2) AS perc_com_alertas,\\r\\n    \\r\\n    -- Setores Representados\\r\\n    COUNT(DISTINCT e.cnae_classe) AS setores_distintos\\r\\n    \\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON e.nu_cnpj = a.nu_cnpj AND e.nu_per_ref = a.nu_per_ref\\r\\nWHERE e.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresas)\\r\\n  AND e.porte_empresa != 'SEM_FATURAMENTO'\\r\\nGROUP BY e.porte_empresa\\r\\nORDER BY \\r\\n    CASE e.porte_empresa\\r\\n        WHEN 'MICRO' THEN 1\\r\\n        WHEN 'PEQUENO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        WHEN 'GRANDE' THEN 4\\r\\n    END;\\r\\n\\r\\n-- 1.3. VALIDA\\u00c7\\u00c3O DE DADOS - CONTAGEM DE REGISTROS\\r\\n-- Objetivo: Verificar a integridade e volume de dados em cada tabela\\r\\nSELECT '1.3. VALIDA\\u00c7\\u00c3O DE DADOS - CONTAGEM DE REGISTROS' AS consulta;\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_unicos,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos_unicos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_benchmark_setorial\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_benchmark_setorial_porte' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_unicos,\\r\\n    COUNT(DISTINCT porte_empresa) AS portes_distintos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_benchmark_setorial_porte\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    COUNT(DISTINCT nu_per_ref) AS periodos_unicos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_empresas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_pagamentos_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    CAST(SUM(qtd_pagamentos) AS BIGINT) AS total_pagamentos,\\r\\n    CONCAT('R$ ', CAST(ROUND(SUM(valor_total_pago)/1000000, 2) AS STRING), 'M') AS valor_total\\r\\nFROM niat.argos_pagamentos_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_empresa_vs_benchmark' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_distintos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_empresa_vs_benchmark\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_setor' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_analisados,\\r\\n    NULL AS portes_ou_periodos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_evolucao_temporal_empresa' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_analisadas,\\r\\n    NULL AS portes_ou_periodos,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_evolucao_temporal_empresa\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_anomalias_setoriais' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cnae_classe) AS setores_anomalos,\\r\\n    COUNT(DISTINCT tipo_anomalia) AS tipos_anomalia,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_anomalias_setoriais\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'argos_alertas_empresas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_alerta,\\r\\n    COUNT(DISTINCT tipo_alerta) AS tipos_alerta,\\r\\n    NULL AS extra_info\\r\\nFROM niat.argos_alertas_empresas;\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 2: CONSULTAS ANAL\\u00cdTICAS (RANKINGS E PADR\\u00d5ES)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1. TOP 20 SETORES POR FATURAMENTO\\r\\n-- Objetivo: Identificar os setores mais representativos economicamente\\r\\nSELECT\\r\\n    '2.1. TOP 20 SETORES POR FATURAMENTO' AS consulta,\\r\\n    \\r\\n    ets.cnae_classe,\\r\\n    ets.desc_cnae_classe,\\r\\n    ets.secao,\\r\\n    ets.desc_secao,\\r\\n    \\r\\n    -- M\\u00e9tricas Agregadas\\r\\n    ROUND(ets.faturamento_acumulado_8m / 1000000000, 2) AS faturamento_8m_bilhoes,\\r\\n    ROUND(ets.icms_devido_acumulado_8m / 1000000000, 2) AS icms_devido_8m_bilhoes,\\r\\n    ROUND(ets.media_empresas_mes, 0) AS media_empresas_mes,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(ets.aliq_mediana_media_8m * 100, 2) AS aliq_mediana_media_pct,\\r\\n    ROUND(ets.aliq_mediana_desvio_8m * 100, 3) AS aliq_desvio_8m_pct,\\r\\n    \\r\\n    -- Volatilidade e Tend\\u00eancia\\r\\n    ets.categoria_volatilidade_temporal,\\r\\n    ets.tendencia_aliquota,\\r\\n    \\r\\n    -- Anomalias\\r\\n    CASE WHEN ans.cnae_classe IS NOT NULL THEN 'SIM' ELSE 'N\\u00c3O' END AS possui_anomalia\\r\\n    \\r\\nFROM niat.argos_evolucao_temporal_setor ets\\r\\nLEFT JOIN niat.argos_anomalias_setoriais ans ON \\r\\n    ets.cnae_classe = ans.cnae_classe\\r\\nWHERE ans.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_anomalias_setoriais) OR ans.cnae_classe IS NULL\\r\\nORDER BY ets.faturamento_acumulado_8m DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 2.2. TOP 30 EMPRESAS POR SCORE DE RISCO\\r\\n-- Objetivo: Listar empresas priorit\\u00e1rias para fiscaliza\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '2.2. TOP 30 EMPRESAS POR SCORE DE RISCO' AS consulta,\\r\\n    \\r\\n    a.nu_cnpj,\\r\\n    a.nm_razao_social,\\r\\n    a.nu_per_ref,\\r\\n    a.cnae_classe,\\r\\n    a.desc_cnae_classe,\\r\\n    a.porte_empresa,\\r\\n    \\r\\n    -- Score e Classifica\\u00e7\\u00e3o\\r\\n    ROUND(a.score_risco, 1) AS score_risco,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(a.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(a.icms_devido / 1000, 2) AS icms_devido_milhares,\\r\\n    ROUND(a.icms_recolher / 1000, 2) AS icms_recolher_milhares,\\r\\n    ROUND(a.valor_total_pago / 1000, 2) AS pagamento_milhares,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(a.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(a.aliq_setor_mediana * 100, 2) AS aliq_setor_mediana_pct,\\r\\n    ROUND(a.indice_vs_mediana_setor, 2) AS indice_vs_setor,\\r\\n    \\r\\n    -- Dados Temporais\\r\\n    ete.categoria_volatilidade AS volatilidade_8m,\\r\\n    ROUND(ete.aliq_coef_variacao_8m, 3) AS coef_variacao_8m\\r\\n    \\r\\nFROM niat.argos_alertas_empresas a\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON a.nu_cnpj = ete.nu_cnpj\\r\\nWHERE a.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_alertas_empresas)\\r\\nORDER BY a.score_risco DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- 2.3. DISTRIBUI\\u00c7\\u00c3O DE ALERTAS POR TIPO E SEVERIDADE\\r\\n-- Objetivo: Entender a composi\\u00e7\\u00e3o dos alertas do sistema\\r\\nSELECT\\r\\n    '2.3. DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS consulta,\\r\\n    \\r\\n    tipo_alerta,\\r\\n    severidade,\\r\\n    COUNT(*) AS quantidade_alertas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual_total,\\r\\n    \\r\\n    -- M\\u00e9tricas dos Alertas\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_distintas,\\r\\n    ROUND(AVG(score_risco), 1) AS score_medio,\\r\\n    ROUND(SUM(vl_faturamento) / 1000000, 2) AS faturamento_total_milhoes,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Porte\\r\\n    COUNT(CASE WHEN porte_empresa = 'MICRO' THEN 1 END) AS micro,\\r\\n    COUNT(CASE WHEN porte_empresa = 'PEQUENO' THEN 1 END) AS pequeno,\\r\\n    COUNT(CASE WHEN porte_empresa = 'MEDIO' THEN 1 END) AS medio,\\r\\n    COUNT(CASE WHEN porte_empresa = 'GRANDE' THEN 1 END) AS grande\\r\\n    \\r\\nFROM niat.argos_alertas_empresas\\r\\nWHERE nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_alertas_empresas)\\r\\nGROUP BY tipo_alerta, severidade\\r\\nORDER BY \\r\\n    CASE severidade\\r\\n        WHEN 'CRITICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        ELSE 4\\r\\n    END,\\r\\n    quantidade_alertas DESC;\\r\\n\\r\\n-- 2.4. AN\\u00c1LISE DE VOLATILIDADE SETORIAL E EMPRESARIAL\\r\\n-- Objetivo: Identificar setores e empresas com maior instabilidade tribut\\u00e1ria\\r\\nSELECT '2.4. AN\\u00c1LISE DE VOLATILIDADE' AS consulta;\\r\\n\\r\\n-- Setores com Alta Volatilidade\\r\\nSELECT \\r\\n    'SETORIAL' AS tipo,\\r\\n    ets.cnae_classe AS identificador,\\r\\n    ets.desc_cnae_classe AS descricao,\\r\\n    ets.categoria_volatilidade_temporal AS categoria,\\r\\n    ROUND(ets.coef_variacao_temporal, 3) AS coef_variacao,\\r\\n    ROUND(ets.aliq_mediana_media_8m * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(ets.faturamento_acumulado_8m / 1000000, 2) AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor ets\\r\\nWHERE ets.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\nORDER BY ets.coef_variacao_temporal DESC\\r\\nLIMIT 20\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Empresas com Alta Volatilidade\\r\\nSELECT \\r\\n    'EMPRESARIAL' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    ROUND(ete.aliq_coef_variacao_8m, 3) AS coef_variacao,\\r\\n    ROUND(ete.aliq_media_8m * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(ete.faturamento_total_8m / 1000000, 2) AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA'\\r\\nORDER BY ete.aliq_coef_variacao_8m DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 2.5. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL\\r\\n-- Objetivo: Observar tend\\u00eancias mensais do sistema\\r\\nWITH alertas_por_periodo AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        COUNT(DISTINCT nu_cnpj) AS qtd_empresas_com_alerta\\r\\n    FROM niat.argos_alertas_empresas\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT\\r\\n    '2.5. EVOLU\\u00c7\\u00c3O MENSAL DO SISTEMA' AS consulta,\\r\\n    \\r\\n    b.nu_per_ref AS periodo,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT b.cnae_classe) AS setores_ativos,\\r\\n    ROUND(AVG(b.qtd_empresas_total), 0) AS media_empresas_setor,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(b.faturamento_total) / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(SUM(b.icms_devido_total) / 1000000000, 2) AS icms_devido_total_bilhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(AVG(b.aliq_efetiva_mediana) * 100, 2) AS aliq_mediana_media_pct,\\r\\n    ROUND(STDDEV(b.aliq_efetiva_mediana) * 100, 3) AS aliq_desvio_entre_setores_pct,\\r\\n    \\r\\n    -- Alertas e Anomalias\\r\\n    COUNT(DISTINCT ans.cnae_classe) AS setores_com_anomalia,\\r\\n    COALESCE(app.qtd_empresas_com_alerta, 0) AS empresas_com_alerta\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_anomalias_setoriais ans ON \\r\\n    b.cnae_classe = ans.cnae_classe AND b.nu_per_ref = ans.nu_per_ref\\r\\nLEFT JOIN alertas_por_periodo app ON b.nu_per_ref = app.nu_per_ref\\r\\nGROUP BY b.nu_per_ref, app.qtd_empresas_com_alerta\\r\\nORDER BY b.nu_per_ref DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE SETOR OU EMPRESA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1. DOSSI\\u00ca COMPLETO DE UM SETOR\\r\\n-- Substitua '47113' pelo CNAE desejado (5 d\\u00edgitos)\\r\\nSELECT\\r\\n    '3.1. DOSSI\\u00ca COMPLETO DO SETOR' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- M\\u00e9tricas do Setor\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    ROUND(b.faturamento_total / 1000000, 2) AS faturamento_milhoes,\\r\\n    ROUND(b.icms_devido_total / 1000000, 2) AS icms_devido_milhoes,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(b.aliq_efetiva_media * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(b.aliq_efetiva_mediana * 100, 2) AS aliq_mediana_pct,\\r\\n    ROUND(b.aliq_efetiva_p25 * 100, 2) AS aliq_p25_pct,\\r\\n    ROUND(b.aliq_efetiva_p75 * 100, 2) AS aliq_p75_pct,\\r\\n    ROUND(b.aliq_efetiva_desvio * 100, 3) AS aliq_desvio_pct,\\r\\n    ROUND(b.aliq_coef_variacao, 3) AS coef_variacao,\\r\\n    \\r\\n    -- Dados Temporais (quando dispon\\u00edvel)\\r\\n    ets.categoria_volatilidade_temporal,\\r\\n    ets.tendencia_aliquota,\\r\\n    ROUND(ets.aliq_mediana_min_8m * 100, 2) AS aliq_min_8m_pct,\\r\\n    ROUND(ets.aliq_mediana_max_8m * 100, 2) AS aliq_max_8m_pct,\\r\\n    \\r\\n    -- Anomalias\\r\\n    ans.tipo_anomalia,\\r\\n    ans.severidade AS severidade_anomalia,\\r\\n    ROUND(ans.score_relevancia, 1) AS score_anomalia\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor ets ON b.cnae_classe = ets.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais ans ON \\r\\n    b.cnae_classe = ans.cnae_classe AND b.nu_per_ref = ans.nu_per_ref\\r\\nWHERE b.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\nORDER BY b.nu_per_ref DESC;\\r\\n\\r\\n-- 3.2. DOSSI\\u00ca COMPLETO DE UMA EMPRESA\\r\\n-- Substitua o CNPJ desejado\\r\\nSELECT\\r\\n    '3.2. DOSSI\\u00ca COMPLETO DA EMPRESA' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    evb.nu_per_ref,\\r\\n    \\r\\n    -- Dados Mensais\\r\\n    ROUND(evb.vl_faturamento, 2) AS faturamento,\\r\\n    ROUND(evb.icms_devido, 2) AS icms_devido,\\r\\n    ROUND(evb.icms_recolher, 2) AS icms_recolher,\\r\\n    evb.qtd_pagamentos,\\r\\n    ROUND(evb.valor_total_pago, 2) AS valor_pago,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.aliq_setor_mediana * 100, 2) AS aliq_setor_mediana_pct,\\r\\n    ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS aliq_porte_mediana_pct,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_setor,\\r\\n    ROUND(evb.indice_vs_mediana_porte, 2) AS indice_vs_porte,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Contexto do Setor\\r\\n    evb.empresas_no_setor,\\r\\n    evb.empresas_mesmo_porte,\\r\\n    \\r\\n    -- Alertas\\r\\n    a.tipo_alerta,\\r\\n    a.severidade,\\r\\n    ROUND(a.score_risco, 1) AS score_risco,\\r\\n    \\r\\n    -- Evolu\\u00e7\\u00e3o Temporal (8 meses - quando dispon\\u00edvel)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade AS volatilidade_8m,\\r\\n    ROUND(ete.aliq_media_8m * 100, 2) AS aliq_media_8m_pct,\\r\\n    ROUND(ete.aliq_coef_variacao_8m, 3) AS coef_variacao_8m,\\r\\n    ROUND(ete.faturamento_total_8m / 1000, 2) AS faturamento_8m_milhares\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE evb.nu_cnpj = '00000000000191'  -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nORDER BY evb.nu_per_ref DESC;\\r\\n\\r\\n-- 3.3. EMPRESAS DO MESMO SETOR - COMPARA\\u00c7\\u00c3O\\r\\n-- Lista todas as empresas de um setor para compara\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '3.3. EMPRESAS DO MESMO SETOR' AS consulta,\\r\\n    \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(evb.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(evb.icms_devido / 1000, 2) AS icms_milhares,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_mediana,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Pagamentos\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    ROUND(evb.valor_total_pago / 1000, 2) AS pagamentos_milhares,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 'SIM' ELSE 'N\\u00c3O' END AS possui_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nWHERE evb.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\n  AND evb.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresa_vs_benchmark)\\r\\n  AND evb.aliq_efetiva_empresa IS NOT NULL\\r\\nORDER BY evb.vl_faturamento DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES ESPEC\\u00cdFICAS E CEN\\u00c1RIOS DE RISCO\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1. EMPRESAS COM DIVERG\\u00caNCIA CR\\u00cdTICA ENTRE ICMS E PAGAMENTOS\\r\\n-- Objetivo: Identificar poss\\u00edvel sonega\\u00e7\\u00e3o ou problemas cadastrais\\r\\nSELECT\\r\\n    '4.1. DIVERG\\u00caNCIA CR\\u00cdTICA ICMS vs PAGAMENTOS' AS consulta,\\r\\n    \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    e.nu_per_ref,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(e.icms_recolher / 1000, 2) AS icms_recolher_milhares,\\r\\n    ROUND(p.valor_total_pago / 1000, 2) AS valor_pago_milhares,\\r\\n    ROUND((e.icms_recolher - p.valor_total_pago) / 1000, 2) AS diferenca_milhares,\\r\\n    \\r\\n    -- Percentual de Diverg\\u00eancia\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 \\r\\n        THEN ROUND(ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1)\\r\\n        ELSE NULL\\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.5 THEN 'DIVERGENCIA_EXTREMA'\\r\\n        WHEN ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        ELSE 'DIVERGENCIA_MODERADA'\\r\\n    END AS classificacao,\\r\\n    \\r\\n    -- Contexto\\r\\n    ROUND(e.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    p.qtd_pagamentos,\\r\\n    \\r\\n    -- Score de Risco\\r\\n    a.score_risco\\r\\n    \\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON e.nu_cnpj = a.nu_cnpj AND e.nu_per_ref = a.nu_per_ref\\r\\nWHERE e.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresas)\\r\\n  AND (\\r\\n    (e.icms_recolher > 100 AND p.valor_total_pago = 0) OR\\r\\n    (e.icms_recolher > 0 AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3)\\r\\n  )\\r\\nORDER BY ABS(e.icms_recolher - p.valor_total_pago) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- 4.2. AN\\u00c1LISE DE BENCHMARKING POR PORTE DENTRO DO SETOR\\r\\n-- Objetivo: Comparar empresas do mesmo porte dentro do setor\\r\\nSELECT\\r\\n    '4.2. BENCHMARKING POR PORTE NO SETOR' AS consulta,\\r\\n    \\r\\n    bp.cnae_classe,\\r\\n    bp.desc_cnae_classe,\\r\\n    bp.porte_empresa,\\r\\n    bp.nu_per_ref,\\r\\n    \\r\\n    -- Contagens\\r\\n    bp.qtd_empresas,\\r\\n    bp.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Al\\u00edquotas por Porte\\r\\n    ROUND(bp.aliq_efetiva_media * 100, 2) AS aliq_media_porte_pct,\\r\\n    ROUND(bp.aliq_efetiva_mediana * 100, 2) AS aliq_mediana_porte_pct,\\r\\n    ROUND(bp.aliq_efetiva_desvio * 100, 3) AS aliq_desvio_porte_pct,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com Setor Geral\\r\\n    b.aliq_efetiva_mediana AS aliq_setor_geral,\\r\\n    ROUND((bp.aliq_efetiva_mediana - b.aliq_efetiva_mediana) * 100, 2) AS diferenca_vs_setor_geral_pp,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    ROUND(bp.faturamento_total / 1000000, 2) AS faturamento_porte_milhoes,\\r\\n    ROUND(bp.faturamento_medio / 1000, 2) AS faturamento_medio_milhares\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial_porte bp\\r\\nINNER JOIN niat.argos_benchmark_setorial b ON \\r\\n    bp.cnae_classe = b.cnae_classe AND bp.nu_per_ref = b.nu_per_ref\\r\\nWHERE bp.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\n  AND bp.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_benchmark_setorial_porte)\\r\\nORDER BY \\r\\n    CASE bp.porte_empresa\\r\\n        WHEN 'MICRO' THEN 1\\r\\n        WHEN 'PEQUENO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        WHEN 'GRANDE' THEN 4\\r\\n    END;\\r\\n\\r\\n-- 4.3. EMPRESAS COM AL\\u00cdQUOTA ABAIXO DO SETOR E ALTO FATURAMENTO\\r\\n-- Objetivo: Identificar potencial planejamento tribut\\u00e1rio agressivo\\r\\nSELECT\\r\\n    '4.3. AL\\u00cdQUOTA BAIXA COM ALTO FATURAMENTO' AS consulta,\\r\\n    \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(evb.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(evb.icms_devido / 1000, 2) AS icms_devido_milhares,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.aliq_setor_mediana * 100, 2) AS aliq_setor_mediana_pct,\\r\\n    ROUND((evb.aliq_setor_mediana - evb.aliq_efetiva_empresa) * 100, 2) AS diferenca_pp,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_setor,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Impacto Estimado se alinhasse ao setor\\r\\n    ROUND(evb.vl_faturamento * (evb.aliq_setor_mediana - evb.aliq_efetiva_empresa) / 1000, 2) AS impacto_estimado_milhares,\\r\\n    \\r\\n    -- Contexto\\r\\n    evb.empresas_no_setor,\\r\\n    ete.categoria_volatilidade,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nWHERE evb.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresa_vs_benchmark)\\r\\n  AND evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n  AND evb.vl_faturamento > 100000  -- Faturamento > R$ 100 mil\\r\\n  AND evb.aliq_efetiva_empresa IS NOT NULL\\r\\nORDER BY (evb.vl_faturamento * (evb.aliq_setor_mediana - evb.aliq_efetiva_empresa)) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- 4.4. AN\\u00c1LISE DE ANOMALIAS SETORIAIS COM IMPACTO\\r\\n-- Objetivo: Priorizar setores an\\u00f4malos por relev\\u00e2ncia econ\\u00f4mica\\r\\nSELECT\\r\\n    '4.4. ANOMALIAS SETORIAIS PRIORIT\\u00c1RIAS' AS consulta,\\r\\n    \\r\\n    ans.cnae_classe,\\r\\n    ans.desc_cnae_classe,\\r\\n    ans.secao,\\r\\n    ans.tipo_anomalia,\\r\\n    ans.severidade,\\r\\n    ROUND(ans.score_relevancia, 1) AS score,\\r\\n    \\r\\n    -- Dados do Setor\\r\\n    ans.qtd_empresas_total,\\r\\n    ROUND(ans.faturamento_total / 1000000, 2) AS faturamento_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(ans.aliq_setor * 100, 2) AS aliq_setor_pct,\\r\\n    ROUND(ans.aliq_mediana_economia * 100, 2) AS aliq_economia_pct,\\r\\n    ROUND((ans.aliq_setor - ans.aliq_mediana_economia) * 100, 2) AS diferenca_pp,\\r\\n    ROUND(ans.indice_vs_economia, 2) AS indice_vs_economia,\\r\\n    \\r\\n    -- Impacto Estimado\\r\\n    ROUND(ans.faturamento_total * ABS(ans.aliq_setor - ans.aliq_mediana_economia) / 1000000, 2) AS impacto_estimado_milhoes,\\r\\n    \\r\\n    -- Contexto\\r\\n    ets.categoria_volatilidade_temporal,\\r\\n    ets.tendencia_aliquota\\r\\n    \\r\\nFROM niat.argos_anomalias_setoriais ans\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor ets ON ans.cnae_classe = ets.cnae_classe\\r\\nWHERE ans.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_anomalias_setoriais)\\r\\nORDER BY ans.score_relevancia DESC, ans.faturamento_total DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 5: DASHBOARD EXECUTIVO E MONITORAMENTO\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1. DASHBOARD EXECUTIVO - KPIs PRINCIPAIS\\r\\n-- Objetivo: Vis\\u00e3o executiva consolidada para acompanhamento gerencial\\r\\nWITH \\r\\nperiodo_atual AS (\\r\\n    SELECT MAX(nu_per_ref) AS periodo FROM niat.argos_empresas\\r\\n),\\r\\nmetricas_setores AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS total_setores\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_empresas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n        SUM(vl_faturamento) AS faturamento_total,\\r\\n        SUM(icms_devido) AS icms_total\\r\\n    FROM niat.argos_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_alertas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_alertas,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'CRITICO' THEN nu_cnpj END) AS alertas_criticos,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'ALTO' THEN nu_cnpj END) AS alertas_altos\\r\\n    FROM niat.argos_alertas_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_pagamentos AS (\\r\\n    SELECT \\r\\n        SUM(valor_total_pago) AS pagamentos_total\\r\\n    FROM niat.argos_pagamentos_empresa \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_benchmark AS (\\r\\n    SELECT \\r\\n        AVG(aliq_efetiva_mediana) AS aliq_media\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_anomalias AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS setores_anomalos\\r\\n    FROM niat.argos_anomalias_setoriais \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n)\\r\\nSELECT\\r\\n    '5.1. DASHBOARD EXECUTIVO - KPIs' AS consulta,\\r\\n    \\r\\n    -- Per\\u00edodo de Refer\\u00eancia\\r\\n    pa.periodo AS periodo_referencia,\\r\\n    \\r\\n    -- M\\u00e9tricas Principais\\r\\n    ms.total_setores,\\r\\n    me.total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    ma.alertas_criticos,\\r\\n    ma.alertas_altos,\\r\\n    \\r\\n    -- Percentual de Empresas com Alertas\\r\\n    ROUND(ma.total_alertas * 100.0 / NULLIF(me.total_empresas, 0), 2) AS perc_empresas_com_alerta,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(me.faturamento_total / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(me.icms_total / 1000000000, 2) AS icms_devido_bilhoes,\\r\\n    ROUND(mp.pagamentos_total / 1000000000, 2) AS pagamentos_bilhoes,\\r\\n    \\r\\n    -- Al\\u00edquota M\\u00e9dia do Sistema\\r\\n    ROUND(mb.aliq_media * 100, 2) AS aliq_media_sistema_pct,\\r\\n    \\r\\n    -- Setores com Anomalias\\r\\n    man.setores_anomalos,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM periodo_atual pa\\r\\nCROSS JOIN metricas_setores ms\\r\\nCROSS JOIN metricas_empresas me\\r\\nCROSS JOIN metricas_alertas ma\\r\\nCROSS JOIN metricas_pagamentos mp\\r\\nCROSS JOIN metricas_benchmark mb\\r\\nCROSS JOIN metricas_anomalias man;\\r\\n\\r\\n-- 5.2. ALERTAS AUTOM\\u00c1TICOS PARA A\\u00c7\\u00c3O IMEDIATA\\r\\n-- Objetivo: Lista de prioridades para o dia\\r\\nSELECT\\r\\n    '5.2. ALERTAS PARA A\\u00c7\\u00c3O IMEDIATA' AS consulta,\\r\\n    \\r\\n    a.nu_cnpj,\\r\\n    a.nm_razao_social,\\r\\n    a.cnae_classe,\\r\\n    a.porte_empresa,\\r\\n    \\r\\n    -- Prioridade (1 = M\\u00e1xima, 4 = Baixa)\\r\\n    CASE a.severidade\\r\\n        WHEN 'CRITICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        ELSE 4\\r\\n    END AS prioridade_numerica,\\r\\n    \\r\\n    a.severidade,\\r\\n    a.tipo_alerta,\\r\\n    ROUND(a.score_risco, 1) AS score,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE a.tipo_alerta\\r\\n        WHEN 'ALIQUOTA_MUITO_ABAIXO_SETOR' THEN 'Verificar classifica\\u00e7\\u00e3o fiscal e cr\\u00e9ditos'\\r\\n        WHEN 'DIVERGENCIA_ICMS_PAGAMENTO' THEN 'Auditar pagamentos e d\\u00e9bitos declarados'\\r\\n        WHEN 'ALTA_VOLATILIDADE_TEMPORAL' THEN 'Analisar mudan\\u00e7as frequentes de regime'\\r\\n        ELSE 'Monitoramento intensificado'\\r\\n    END AS acao_sugerida,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    ROUND(a.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(a.icms_devido / 1000, 2) AS icms_milhares,\\r\\n    ROUND(a.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(a.aliq_setor_mediana * 100, 2) AS aliq_setor_pct\\r\\n    \\r\\nFROM niat.argos_alertas_empresas a\\r\\nWHERE a.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_alertas_empresas)\\r\\n  AND a.severidade IN ('CRITICO', 'ALTO')\\r\\nORDER BY \\r\\n    CASE a.severidade\\r\\n        WHEN 'CRITICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n    END,\\r\\n    a.score_risco DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- INSTRU\\u00c7\\u00d5ES DE USO:\\r\\n-- \\r\\n-- 1. Para an\\u00e1lise de setor espec\\u00edfico: Modifique o cnae_classe nas queries 3.1 e 4.2\\r\\n-- 2. Para an\\u00e1lise de empresa espec\\u00edfica: Modifique o nu_cnpj nas queries 3.2\\r\\n-- 3. Para compara\\u00e7\\u00e3o setorial: Use a query 3.3 modificando o cnae_classe\\r\\n-- 4. Para monitoramento di\\u00e1rio: Execute as queries 5.1 e 5.2\\r\\n-- \\r\\n-- DICAS:\\r\\n-- - As queries est\\u00e3o otimizadas para usar os \\u00faltimos per\\u00edodos dispon\\u00edveis\\r\\n-- - Valores s\\u00e3o formatados para facilitar leitura (milhares/milh\\u00f5es/bilh\\u00f5es)\\r\\n-- - Percentuais j\\u00e1 v\\u00eam calculados e arredondados\\r\\n-- - Use LIMIT para controlar volume de resultados em an\\u00e1lises explorat\\u00f3rias\\r\\n-- \\r\\n-- ============================================================================\", \"statementsList\": [\"\\r\\n\\r\\n-- 2.4. AN\\u00c1LISE DE VOLATILIDADE SETORIAL E EMPRESARIAL\\r\\n-- Objetivo: Identificar setores e empresas com maior instabilidade tribut\\u00e1ria\\r\\nSELECT '2.4. AN\\u00c1LISE DE VOLATILIDADE' AS consulta;\", \"\\r\\n\\r\\n-- Setores com Alta Volatilidade\\r\\nSELECT \\r\\n    'SETORIAL' AS tipo,\\r\\n    ets.cnae_classe AS identificador,\\r\\n    ets.desc_cnae_classe AS descricao,\\r\\n    ets.categoria_volatilidade_temporal AS categoria,\\r\\n    ROUND(ets.coef_variacao_temporal, 3) AS coef_variacao,\\r\\n    ROUND(ets.aliq_mediana_media_8m * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(ets.faturamento_acumulado_8m / 1000000, 2) AS faturamento_milhoes,\\r\\n    NULL AS porte\\r\\nFROM niat.argos_evolucao_temporal_setor ets\\r\\nWHERE ets.categoria_volatilidade_temporal IN ('ALTA', 'MEDIA')\\r\\nORDER BY ets.coef_variacao_temporal DESC\\r\\nLIMIT 20\\r\\n\\r\\nUNION ALL\\r\\n\\r\\n-- Empresas com Alta Volatilidade\\r\\nSELECT \\r\\n    'EMPRESARIAL' AS tipo,\\r\\n    ete.nu_cnpj AS identificador,\\r\\n    ete.nm_razao_social AS descricao,\\r\\n    ete.categoria_volatilidade AS categoria,\\r\\n    ROUND(ete.aliq_coef_variacao_8m, 3) AS coef_variacao,\\r\\n    ROUND(ete.aliq_media_8m * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(ete.faturamento_total_8m / 1000000, 2) AS faturamento_milhoes,\\r\\n    ete.porte_predominante AS porte\\r\\nFROM niat.argos_evolucao_temporal_empresa ete\\r\\nWHERE ete.categoria_volatilidade = 'ALTA'\\r\\nORDER BY ete.aliq_coef_variacao_8m DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 2.5. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL\\r\\n-- Objetivo: Observar tend\\u00eancias mensais do sistema\\r\\nWITH alertas_por_periodo AS (\\r\\n    SELECT \\r\\n        nu_per_ref,\\r\\n        COUNT(DISTINCT nu_cnpj) AS qtd_empresas_com_alerta\\r\\n    FROM niat.argos_alertas_empresas\\r\\n    GROUP BY nu_per_ref\\r\\n)\\r\\nSELECT\\r\\n    '2.5. EVOLU\\u00c7\\u00c3O MENSAL DO SISTEMA' AS consulta,\\r\\n    \\r\\n    b.nu_per_ref AS periodo,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT b.cnae_classe) AS setores_ativos,\\r\\n    ROUND(AVG(b.qtd_empresas_total), 0) AS media_empresas_setor,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(b.faturamento_total) / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(SUM(b.icms_devido_total) / 1000000000, 2) AS icms_devido_total_bilhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(AVG(b.aliq_efetiva_mediana) * 100, 2) AS aliq_mediana_media_pct,\\r\\n    ROUND(STDDEV(b.aliq_efetiva_mediana) * 100, 3) AS aliq_desvio_entre_setores_pct,\\r\\n    \\r\\n    -- Alertas e Anomalias\\r\\n    COUNT(DISTINCT ans.cnae_classe) AS setores_com_anomalia,\\r\\n    COALESCE(app.qtd_empresas_com_alerta, 0) AS empresas_com_alerta\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_anomalias_setoriais ans ON \\r\\n    b.cnae_classe = ans.cnae_classe AND b.nu_per_ref = ans.nu_per_ref\\r\\nLEFT JOIN alertas_por_periodo app ON b.nu_per_ref = app.nu_per_ref\\r\\nGROUP BY b.nu_per_ref, app.qtd_empresas_com_alerta\\r\\nORDER BY b.nu_per_ref DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE SETOR OU EMPRESA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1. DOSSI\\u00ca COMPLETO DE UM SETOR\\r\\n-- Substitua '47113' pelo CNAE desejado (5 d\\u00edgitos)\\r\\nSELECT\\r\\n    '3.1. DOSSI\\u00ca COMPLETO DO SETOR' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    b.cnae_classe,\\r\\n    b.desc_cnae_classe,\\r\\n    b.secao,\\r\\n    b.desc_secao,\\r\\n    b.nu_per_ref,\\r\\n    \\r\\n    -- M\\u00e9tricas do Setor\\r\\n    b.qtd_empresas_total,\\r\\n    b.qtd_empresas_ativas,\\r\\n    ROUND(b.faturamento_total / 1000000, 2) AS faturamento_milhoes,\\r\\n    ROUND(b.icms_devido_total / 1000000, 2) AS icms_devido_milhoes,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(b.aliq_efetiva_media * 100, 2) AS aliq_media_pct,\\r\\n    ROUND(b.aliq_efetiva_mediana * 100, 2) AS aliq_mediana_pct,\\r\\n    ROUND(b.aliq_efetiva_p25 * 100, 2) AS aliq_p25_pct,\\r\\n    ROUND(b.aliq_efetiva_p75 * 100, 2) AS aliq_p75_pct,\\r\\n    ROUND(b.aliq_efetiva_desvio * 100, 3) AS aliq_desvio_pct,\\r\\n    ROUND(b.aliq_coef_variacao, 3) AS coef_variacao,\\r\\n    \\r\\n    -- Dados Temporais (quando dispon\\u00edvel)\\r\\n    ets.categoria_volatilidade_temporal,\\r\\n    ets.tendencia_aliquota,\\r\\n    ROUND(ets.aliq_mediana_min_8m * 100, 2) AS aliq_min_8m_pct,\\r\\n    ROUND(ets.aliq_mediana_max_8m * 100, 2) AS aliq_max_8m_pct,\\r\\n    \\r\\n    -- Anomalias\\r\\n    ans.tipo_anomalia,\\r\\n    ans.severidade AS severidade_anomalia,\\r\\n    ROUND(ans.score_relevancia, 1) AS score_anomalia\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial b\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor ets ON b.cnae_classe = ets.cnae_classe\\r\\nLEFT JOIN niat.argos_anomalias_setoriais ans ON \\r\\n    b.cnae_classe = ans.cnae_classe AND b.nu_per_ref = ans.nu_per_ref\\r\\nWHERE b.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\nORDER BY b.nu_per_ref DESC;\", \"\\r\\n\\r\\n-- 3.2. DOSSI\\u00ca COMPLETO DE UMA EMPRESA\\r\\n-- Substitua o CNPJ desejado\\r\\nSELECT\\r\\n    '3.2. DOSSI\\u00ca COMPLETO DA EMPRESA' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    evb.nu_per_ref,\\r\\n    \\r\\n    -- Dados Mensais\\r\\n    ROUND(evb.vl_faturamento, 2) AS faturamento,\\r\\n    ROUND(evb.icms_devido, 2) AS icms_devido,\\r\\n    ROUND(evb.icms_recolher, 2) AS icms_recolher,\\r\\n    evb.qtd_pagamentos,\\r\\n    ROUND(evb.valor_total_pago, 2) AS valor_pago,\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.aliq_setor_mediana * 100, 2) AS aliq_setor_mediana_pct,\\r\\n    ROUND(COALESCE(evb.aliq_porte_mediana, evb.aliq_setor_mediana) * 100, 2) AS aliq_porte_mediana_pct,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_setor,\\r\\n    ROUND(evb.indice_vs_mediana_porte, 2) AS indice_vs_porte,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Contexto do Setor\\r\\n    evb.empresas_no_setor,\\r\\n    evb.empresas_mesmo_porte,\\r\\n    \\r\\n    -- Alertas\\r\\n    a.tipo_alerta,\\r\\n    a.severidade,\\r\\n    ROUND(a.score_risco, 1) AS score_risco,\\r\\n    \\r\\n    -- Evolu\\u00e7\\u00e3o Temporal (8 meses - quando dispon\\u00edvel)\\r\\n    ete.meses_com_declaracao,\\r\\n    ete.categoria_volatilidade AS volatilidade_8m,\\r\\n    ROUND(ete.aliq_media_8m * 100, 2) AS aliq_media_8m_pct,\\r\\n    ROUND(ete.aliq_coef_variacao_8m, 3) AS coef_variacao_8m,\\r\\n    ROUND(ete.faturamento_total_8m / 1000, 2) AS faturamento_8m_milhares\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nWHERE evb.nu_cnpj = '00000000000191'  -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nORDER BY evb.nu_per_ref DESC;\", \"\\r\\n\\r\\n-- 3.3. EMPRESAS DO MESMO SETOR - COMPARA\\u00c7\\u00c3O\\r\\n-- Lista todas as empresas de um setor para compara\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '3.3. EMPRESAS DO MESMO SETOR' AS consulta,\\r\\n    \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(evb.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(evb.icms_devido / 1000, 2) AS icms_milhares,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_mediana,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Pagamentos\\r\\n    evb.flag_divergencia_pagamento,\\r\\n    ROUND(evb.valor_total_pago / 1000, 2) AS pagamentos_milhares,\\r\\n    \\r\\n    -- Volatilidade\\r\\n    ete.categoria_volatilidade,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN a.nu_cnpj IS NOT NULL THEN 'SIM' ELSE 'N\\u00c3O' END AS possui_alerta,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nWHERE evb.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\n  AND evb.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresa_vs_benchmark)\\r\\n  AND evb.aliq_efetiva_empresa IS NOT NULL\\r\\nORDER BY evb.vl_faturamento DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES ESPEC\\u00cdFICAS E CEN\\u00c1RIOS DE RISCO\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1. EMPRESAS COM DIVERG\\u00caNCIA CR\\u00cdTICA ENTRE ICMS E PAGAMENTOS\\r\\n-- Objetivo: Identificar poss\\u00edvel sonega\\u00e7\\u00e3o ou problemas cadastrais\\r\\nSELECT\\r\\n    '4.1. DIVERG\\u00caNCIA CR\\u00cdTICA ICMS vs PAGAMENTOS' AS consulta,\\r\\n    \\r\\n    e.nu_cnpj,\\r\\n    e.nm_razao_social,\\r\\n    e.cnae_classe,\\r\\n    e.desc_cnae_classe,\\r\\n    e.porte_empresa,\\r\\n    e.nu_per_ref,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(e.icms_recolher / 1000, 2) AS icms_recolher_milhares,\\r\\n    ROUND(p.valor_total_pago / 1000, 2) AS valor_pago_milhares,\\r\\n    ROUND((e.icms_recolher - p.valor_total_pago) / 1000, 2) AS diferenca_milhares,\\r\\n    \\r\\n    -- Percentual de Diverg\\u00eancia\\r\\n    CASE \\r\\n        WHEN e.icms_recolher > 0 \\r\\n        THEN ROUND(ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) * 100, 1)\\r\\n        ELSE NULL\\r\\n    END AS perc_divergencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN e.icms_recolher > 100 AND p.valor_total_pago = 0 THEN 'SEM_PAGAMENTO'\\r\\n        WHEN ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.5 THEN 'DIVERGENCIA_EXTREMA'\\r\\n        WHEN ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3 THEN 'DIVERGENCIA_ALTA'\\r\\n        ELSE 'DIVERGENCIA_MODERADA'\\r\\n    END AS classificacao,\\r\\n    \\r\\n    -- Contexto\\r\\n    ROUND(e.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    p.qtd_pagamentos,\\r\\n    \\r\\n    -- Score de Risco\\r\\n    a.score_risco\\r\\n    \\r\\nFROM niat.argos_empresas e\\r\\nLEFT JOIN niat.argos_pagamentos_empresa p ON e.nu_cnpj = p.nu_cnpj AND e.nu_per_ref = p.nu_per_ref\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON e.nu_cnpj = a.nu_cnpj AND e.nu_per_ref = a.nu_per_ref\\r\\nWHERE e.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresas)\\r\\n  AND (\\r\\n    (e.icms_recolher > 100 AND p.valor_total_pago = 0) OR\\r\\n    (e.icms_recolher > 0 AND ABS(e.icms_recolher - p.valor_total_pago) / NULLIF(e.icms_recolher, 0) > 0.3)\\r\\n  )\\r\\nORDER BY ABS(e.icms_recolher - p.valor_total_pago) DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- 4.2. AN\\u00c1LISE DE BENCHMARKING POR PORTE DENTRO DO SETOR\\r\\n-- Objetivo: Comparar empresas do mesmo porte dentro do setor\\r\\nSELECT\\r\\n    '4.2. BENCHMARKING POR PORTE NO SETOR' AS consulta,\\r\\n    \\r\\n    bp.cnae_classe,\\r\\n    bp.desc_cnae_classe,\\r\\n    bp.porte_empresa,\\r\\n    bp.nu_per_ref,\\r\\n    \\r\\n    -- Contagens\\r\\n    bp.qtd_empresas,\\r\\n    bp.qtd_empresas_ativas,\\r\\n    \\r\\n    -- Al\\u00edquotas por Porte\\r\\n    ROUND(bp.aliq_efetiva_media * 100, 2) AS aliq_media_porte_pct,\\r\\n    ROUND(bp.aliq_efetiva_mediana * 100, 2) AS aliq_mediana_porte_pct,\\r\\n    ROUND(bp.aliq_efetiva_desvio * 100, 3) AS aliq_desvio_porte_pct,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com Setor Geral\\r\\n    b.aliq_efetiva_mediana AS aliq_setor_geral,\\r\\n    ROUND((bp.aliq_efetiva_mediana - b.aliq_efetiva_mediana) * 100, 2) AS diferenca_vs_setor_geral_pp,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    ROUND(bp.faturamento_total / 1000000, 2) AS faturamento_porte_milhoes,\\r\\n    ROUND(bp.faturamento_medio / 1000, 2) AS faturamento_medio_milhares\\r\\n    \\r\\nFROM niat.argos_benchmark_setorial_porte bp\\r\\nINNER JOIN niat.argos_benchmark_setorial b ON \\r\\n    bp.cnae_classe = b.cnae_classe AND bp.nu_per_ref = b.nu_per_ref\\r\\nWHERE bp.cnae_classe = '47113'  -- << MODIFIQUE AQUI O CNAE ALVO\\r\\n  AND bp.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_benchmark_setorial_porte)\\r\\nORDER BY \\r\\n    CASE bp.porte_empresa\\r\\n        WHEN 'MICRO' THEN 1\\r\\n        WHEN 'PEQUENO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        WHEN 'GRANDE' THEN 4\\r\\n    END;\", \"\\r\\n\\r\\n-- 4.3. EMPRESAS COM AL\\u00cdQUOTA ABAIXO DO SETOR E ALTO FATURAMENTO\\r\\n-- Objetivo: Identificar potencial planejamento tribut\\u00e1rio agressivo\\r\\nSELECT\\r\\n    '4.3. AL\\u00cdQUOTA BAIXA COM ALTO FATURAMENTO' AS consulta,\\r\\n    \\r\\n    evb.nu_cnpj,\\r\\n    evb.nm_razao_social,\\r\\n    evb.cnae_classe,\\r\\n    evb.desc_cnae_classe,\\r\\n    evb.porte_empresa,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(evb.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(evb.icms_devido / 1000, 2) AS icms_devido_milhares,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(evb.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(evb.aliq_setor_mediana * 100, 2) AS aliq_setor_mediana_pct,\\r\\n    ROUND((evb.aliq_setor_mediana - evb.aliq_efetiva_empresa) * 100, 2) AS diferenca_pp,\\r\\n    ROUND(evb.indice_vs_mediana_setor, 2) AS indice_vs_setor,\\r\\n    evb.status_vs_setor,\\r\\n    \\r\\n    -- Impacto Estimado se alinhasse ao setor\\r\\n    ROUND(evb.vl_faturamento * (evb.aliq_setor_mediana - evb.aliq_efetiva_empresa) / 1000, 2) AS impacto_estimado_milhares,\\r\\n    \\r\\n    -- Contexto\\r\\n    evb.empresas_no_setor,\\r\\n    ete.categoria_volatilidade,\\r\\n    a.tipo_alerta,\\r\\n    a.severidade\\r\\n    \\r\\nFROM niat.argos_empresa_vs_benchmark evb\\r\\nLEFT JOIN niat.argos_evolucao_temporal_empresa ete ON evb.nu_cnpj = ete.nu_cnpj\\r\\nLEFT JOIN niat.argos_alertas_empresas a ON \\r\\n    evb.nu_cnpj = a.nu_cnpj AND evb.nu_per_ref = a.nu_per_ref\\r\\nWHERE evb.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_empresa_vs_benchmark)\\r\\n  AND evb.status_vs_setor IN ('MUITO_ABAIXO', 'ABAIXO')\\r\\n  AND evb.vl_faturamento > 100000  -- Faturamento > R$ 100 mil\\r\\n  AND evb.aliq_efetiva_empresa IS NOT NULL\\r\\nORDER BY (evb.vl_faturamento * (evb.aliq_setor_mediana - evb.aliq_efetiva_empresa)) DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- 4.4. AN\\u00c1LISE DE ANOMALIAS SETORIAIS COM IMPACTO\\r\\n-- Objetivo: Priorizar setores an\\u00f4malos por relev\\u00e2ncia econ\\u00f4mica\\r\\nSELECT\\r\\n    '4.4. ANOMALIAS SETORIAIS PRIORIT\\u00c1RIAS' AS consulta,\\r\\n    \\r\\n    ans.cnae_classe,\\r\\n    ans.desc_cnae_classe,\\r\\n    ans.secao,\\r\\n    ans.tipo_anomalia,\\r\\n    ans.severidade,\\r\\n    ROUND(ans.score_relevancia, 1) AS score,\\r\\n    \\r\\n    -- Dados do Setor\\r\\n    ans.qtd_empresas_total,\\r\\n    ROUND(ans.faturamento_total / 1000000, 2) AS faturamento_milhoes,\\r\\n    \\r\\n    -- Al\\u00edquotas\\r\\n    ROUND(ans.aliq_setor * 100, 2) AS aliq_setor_pct,\\r\\n    ROUND(ans.aliq_mediana_economia * 100, 2) AS aliq_economia_pct,\\r\\n    ROUND((ans.aliq_setor - ans.aliq_mediana_economia) * 100, 2) AS diferenca_pp,\\r\\n    ROUND(ans.indice_vs_economia, 2) AS indice_vs_economia,\\r\\n    \\r\\n    -- Impacto Estimado\\r\\n    ROUND(ans.faturamento_total * ABS(ans.aliq_setor - ans.aliq_mediana_economia) / 1000000, 2) AS impacto_estimado_milhoes,\\r\\n    \\r\\n    -- Contexto\\r\\n    ets.categoria_volatilidade_temporal,\\r\\n    ets.tendencia_aliquota\\r\\n    \\r\\nFROM niat.argos_anomalias_setoriais ans\\r\\nLEFT JOIN niat.argos_evolucao_temporal_setor ets ON ans.cnae_classe = ets.cnae_classe\\r\\nWHERE ans.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_anomalias_setoriais)\\r\\nORDER BY ans.score_relevancia DESC, ans.faturamento_total DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 5: DASHBOARD EXECUTIVO E MONITORAMENTO\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1. DASHBOARD EXECUTIVO - KPIs PRINCIPAIS\\r\\n-- Objetivo: Vis\\u00e3o executiva consolidada para acompanhamento gerencial\\r\\nWITH \\r\\nperiodo_atual AS (\\r\\n    SELECT MAX(nu_per_ref) AS periodo FROM niat.argos_empresas\\r\\n),\\r\\nmetricas_setores AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS total_setores\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_empresas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n        SUM(vl_faturamento) AS faturamento_total,\\r\\n        SUM(icms_devido) AS icms_total\\r\\n    FROM niat.argos_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_alertas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_alertas,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'CRITICO' THEN nu_cnpj END) AS alertas_criticos,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'ALTO' THEN nu_cnpj END) AS alertas_altos\\r\\n    FROM niat.argos_alertas_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_pagamentos AS (\\r\\n    SELECT \\r\\n        SUM(valor_total_pago) AS pagamentos_total\\r\\n    FROM niat.argos_pagamentos_empresa \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_benchmark AS (\\r\\n    SELECT \\r\\n        AVG(aliq_efetiva_mediana) AS aliq_media\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_anomalias AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS setores_anomalos\\r\\n    FROM niat.argos_anomalias_setoriais \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n)\\r\\nSELECT\\r\\n    '5.1. DASHBOARD EXECUTIVO - KPIs' AS consulta,\\r\\n    \\r\\n    -- Per\\u00edodo de Refer\\u00eancia\\r\\n    pa.periodo AS periodo_referencia,\\r\\n    \\r\\n    -- M\\u00e9tricas Principais\\r\\n    ms.total_setores,\\r\\n    me.total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    ma.alertas_criticos,\\r\\n    ma.alertas_altos,\\r\\n    \\r\\n    -- Percentual de Empresas com Alertas\\r\\n    ROUND(ma.total_alertas * 100.0 / NULLIF(me.total_empresas, 0), 2) AS perc_empresas_com_alerta,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(me.faturamento_total / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(me.icms_total / 1000000000, 2) AS icms_devido_bilhoes,\\r\\n    ROUND(mp.pagamentos_total / 1000000000, 2) AS pagamentos_bilhoes,\\r\\n    \\r\\n    -- Al\\u00edquota M\\u00e9dia do Sistema\\r\\n    ROUND(mb.aliq_media * 100, 2) AS aliq_media_sistema_pct,\\r\\n    \\r\\n    -- Setores com Anomalias\\r\\n    man.setores_anomalos,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM periodo_atual pa\\r\\nCROSS JOIN metricas_setores ms\\r\\nCROSS JOIN metricas_empresas me\\r\\nCROSS JOIN metricas_alertas ma\\r\\nCROSS JOIN metricas_pagamentos mp\\r\\nCROSS JOIN metricas_benchmark mb\\r\\nCROSS JOIN metricas_anomalias man;\", \"\\r\\n\\r\\n-- 5.2. ALERTAS AUTOM\\u00c1TICOS PARA A\\u00c7\\u00c3O IMEDIATA\\r\\n-- Objetivo: Lista de prioridades para o dia\\r\\nSELECT\\r\\n    '5.2. ALERTAS PARA A\\u00c7\\u00c3O IMEDIATA' AS consulta,\\r\\n    \\r\\n    a.nu_cnpj,\\r\\n    a.nm_razao_social,\\r\\n    a.cnae_classe,\\r\\n    a.porte_empresa,\\r\\n    \\r\\n    -- Prioridade (1 = M\\u00e1xima, 4 = Baixa)\\r\\n    CASE a.severidade\\r\\n        WHEN 'CRITICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'MEDIO' THEN 3\\r\\n        ELSE 4\\r\\n    END AS prioridade_numerica,\\r\\n    \\r\\n    a.severidade,\\r\\n    a.tipo_alerta,\\r\\n    ROUND(a.score_risco, 1) AS score,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE a.tipo_alerta\\r\\n        WHEN 'ALIQUOTA_MUITO_ABAIXO_SETOR' THEN 'Verificar classifica\\u00e7\\u00e3o fiscal e cr\\u00e9ditos'\\r\\n        WHEN 'DIVERGENCIA_ICMS_PAGAMENTO' THEN 'Auditar pagamentos e d\\u00e9bitos declarados'\\r\\n        WHEN 'ALTA_VOLATILIDADE_TEMPORAL' THEN 'Analisar mudan\\u00e7as frequentes de regime'\\r\\n        ELSE 'Monitoramento intensificado'\\r\\n    END AS acao_sugerida,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    ROUND(a.vl_faturamento / 1000, 2) AS faturamento_milhares,\\r\\n    ROUND(a.icms_devido / 1000, 2) AS icms_milhares,\\r\\n    ROUND(a.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\r\\n    ROUND(a.aliq_setor_mediana * 100, 2) AS aliq_setor_pct\\r\\n    \\r\\nFROM niat.argos_alertas_empresas a\\r\\nWHERE a.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_alertas_empresas)\\r\\n  AND a.severidade IN ('CRITICO', 'ALTO')\\r\\nORDER BY \\r\\n    CASE a.severidade\\r\\n        WHEN 'CRITICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n    END,\\r\\n    a.score_risco DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS\\r\\n-- ============================================================================\\r\\n-- \\r\\n-- INSTRU\\u00c7\\u00d5ES DE USO:\\r\\n-- \\r\\n-- 1. Para an\\u00e1lise de setor espec\\u00edfico: Modifique o cnae_classe nas queries 3.1 e 4.2\\r\\n-- 2. Para an\\u00e1lise de empresa espec\\u00edfica: Modifique o nu_cnpj nas queries 3.2\\r\\n-- 3. Para compara\\u00e7\\u00e3o setorial: Use a query 3.3 modificando o cnae_classe\\r\\n-- 4. Para monitoramento di\\u00e1rio: Execute as queries 5.1 e 5.2\\r\\n-- \\r\\n-- DICAS:\\r\\n-- - As queries est\\u00e3o otimizadas para usar os \\u00faltimos per\\u00edodos dispon\\u00edveis\\r\\n-- - Valores s\\u00e3o formatados para facilitar leitura (milhares/milh\\u00f5es/bilh\\u00f5es)\\r\\n-- - Percentuais j\\u00e1 v\\u00eam calculados e arredondados\\r\\n-- - Use LIMIT para controlar volume de resultados em an\\u00e1lises explorat\\u00f3rias\\r\\n-- \\r\\n-- ============================================================================\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 5: DASHBOARD EXECUTIVO E MONITORAMENTO\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1. DASHBOARD EXECUTIVO - KPIs PRINCIPAIS\\r\\n-- Objetivo: Vis\\u00e3o executiva consolidada para acompanhamento gerencial\\r\\nWITH \\r\\nperiodo_atual AS (\\r\\n    SELECT MAX(nu_per_ref) AS periodo FROM niat.argos_empresas\\r\\n),\\r\\nmetricas_setores AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS total_setores\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_empresas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n        SUM(vl_faturamento) AS faturamento_total,\\r\\n        SUM(icms_devido) AS icms_total\\r\\n    FROM niat.argos_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_alertas AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT nu_cnpj) AS total_alertas,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'CRITICO' THEN nu_cnpj END) AS alertas_criticos,\\r\\n        COUNT(DISTINCT CASE WHEN severidade = 'ALTO' THEN nu_cnpj END) AS alertas_altos\\r\\n    FROM niat.argos_alertas_empresas \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_pagamentos AS (\\r\\n    SELECT \\r\\n        SUM(valor_total_pago) AS pagamentos_total\\r\\n    FROM niat.argos_pagamentos_empresa \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_benchmark AS (\\r\\n    SELECT \\r\\n        AVG(aliq_efetiva_mediana) AS aliq_media\\r\\n    FROM niat.argos_benchmark_setorial \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n),\\r\\nmetricas_anomalias AS (\\r\\n    SELECT \\r\\n        COUNT(DISTINCT cnae_classe) AS setores_anomalos\\r\\n    FROM niat.argos_anomalias_setoriais \\r\\n    WHERE nu_per_ref = (SELECT periodo FROM periodo_atual)\\r\\n)\\r\\nSELECT\\r\\n    '5.1. DASHBOARD EXECUTIVO - KPIs' AS consulta,\\r\\n    \\r\\n    -- Per\\u00edodo de Refer\\u00eancia\\r\\n    pa.periodo AS periodo_referencia,\\r\\n    \\r\\n    -- M\\u00e9tricas Principais\\r\\n    ms.total_setores,\\r\\n    me.total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    ma.alertas_criticos,\\r\\n    ma.alertas_altos,\\r\\n    \\r\\n    -- Percentual de Empresas com Alertas\\r\\n    ROUND(ma.total_alertas * 100.0 / NULLIF(me.total_empresas, 0), 2) AS perc_empresas_com_alerta,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(me.faturamento_total / 1000000000, 2) AS faturamento_total_bilhoes,\\r\\n    ROUND(me.icms_total / 1000000000, 2) AS icms_devido_bilhoes,\\r\\n    ROUND(mp.pagamentos_total / 1000000000, 2) AS pagamentos_bilhoes,\\r\\n    \\r\\n    -- Al\\u00edquota M\\u00e9dia do Sistema\\r\\n    ROUND(mb.aliq_media * 100, 2) AS aliq_media_sistema_pct,\\r\\n    \\r\\n    -- Setores com Anomalias\\r\\n    man.setores_anomalos,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM periodo_atual pa\\r\\nCROSS JOIN metricas_setores ms\\r\\nCROSS JOIN metricas_empresas me\\r\\nCROSS JOIN metricas_alertas ma\\r\\nCROSS JOIN metricas_pagamentos mp\\r\\nCROSS JOIN metricas_benchmark mb\\r\\nCROSS JOIN metricas_anomalias man;\", \"result\": {\"id\": \"a3b453e6-7045-e34d-9b59-3e57b9a6120c\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"ZHEd67mJSUeGVisWUrK/2Q==\", \"guid\": \"1BiHPsDKSS0AAAAAwaZreA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"7948f039f1db745b:78c8a0d8525a4c8b\", \"session_id\": 21135, \"session_type\": \"impala\", \"statement_id\": 18, \"has_more_statements\": true, \"statements_count\": 20, \"previous_statement_hash\": \"e35bd4a7fb3ff08ea2e55766609f7c097ba15ca9185728dcfca82c36\", \"start\": {\"row\": 759, \"column\": 0}, \"end\": {\"row\": 804, \"column\": 9}, \"statement\": \"-- 5.2. ALERTAS AUTOM\\u00c1TICOS PARA A\\u00c7\\u00c3O IMEDIATA\\n-- Objetivo: Lista de prioridades para o dia\\nSELECT\\n    '5.2. ALERTAS PARA A\\u00c7\\u00c3O IMEDIATA' AS consulta,\\n    \\n    a.nu_cnpj,\\n    a.nm_razao_social,\\n    a.cnae_classe,\\n    a.porte_empresa,\\n    \\n    -- Prioridade (1 = M\\u00e1xima, 4 = Baixa)\\n    CASE a.severidade\\n        WHEN 'CRITICO' THEN 1\\n        WHEN 'ALTO' THEN 2\\n        WHEN 'MEDIO' THEN 3\\n        ELSE 4\\n    END AS prioridade_numerica,\\n    \\n    a.severidade,\\n    a.tipo_alerta,\\n    ROUND(a.score_risco, 1) AS score,\\n    \\n    -- A\\u00e7\\u00e3o Sugerida\\n    CASE a.tipo_alerta\\n        WHEN 'ALIQUOTA_MUITO_ABAIXO_SETOR' THEN 'Verificar classifica\\u00e7\\u00e3o fiscal e cr\\u00e9ditos'\\n        WHEN 'DIVERGENCIA_ICMS_PAGAMENTO' THEN 'Auditar pagamentos e d\\u00e9bitos declarados'\\n        WHEN 'ALTA_VOLATILIDADE_TEMPORAL' THEN 'Analisar mudan\\u00e7as frequentes de regime'\\n        ELSE 'Monitoramento intensificado'\\n    END AS acao_sugerida,\\n    \\n    -- Dados de Contexto\\n    ROUND(a.vl_faturamento / 1000, 2) AS faturamento_milhares,\\n    ROUND(a.icms_devido / 1000, 2) AS icms_milhares,\\n    ROUND(a.aliq_efetiva_empresa * 100, 2) AS aliq_empresa_pct,\\n    ROUND(a.aliq_setor_mediana * 100, 2) AS aliq_setor_pct\\n    \\nFROM niat.argos_alertas_empresas a\\nWHERE a.nu_per_ref = (SELECT MAX(nu_per_ref) FROM niat.argos_alertas_empresas)\\n  AND a.severidade IN ('CRITICO', 'ALTO')\\nORDER BY \\n    CASE a.severidade\\n        WHEN 'CRITICO' THEN 1\\n        WHEN 'ALTO' THEN 2\\n    END,\\n    a.score_risco DESC\\nLIMIT 50\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 18, \"statement_range\": {\"start\": {\"row\": 759, \"column\": 0}, \"end\": {\"row\": 804, \"column\": 9}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-02T20:59:14.229Z\", \"endTime\": \"2025-10-02T20:59:14.229Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"total_setores\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"total_setores\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759438754214, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 9549.37778, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 101, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- CONSULTAS ANALÍTICAS - SISTEMA DE INTELIGÊNCIA SETORIAL TRIBUTÁRIA v4.0\r\n-- Receita Estadual de Santa Catarina\r\n-- ============================================================================\r\n\r\n-- ============================================================================\r\n-- SEÇÃO 1: ESTATÍSTICAS GERAIS DO SISTEMA (VISÃO MACRO)\r\n-- ============================================================================\r\n\r\n-- 1.1. PANORAMA GERAL DO SISTEMA\r\n-- Objetivo: Obter visão executiva completa do ambiente monitorado\r\nSELECT\r\n    '1.1. PANORAMA GERAL DO SISTEMA' AS consulta,\r\n    \r\n    -- Métricas de Volume\r\n    COUNT(DISTINCT b.cnae_classe) AS total_setores_monitorados,\r\n    COUNT(DISTINCT e.nu_cnpj) AS total_empresas_monitoradas,\r\n    COUNT(DISTINCT e.nu_per_ref) AS total_periodos_analisados,\r\n    \r\n    -- Distribuição por Porte\r\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'MICRO' THEN e.nu_cnpj END) AS total_microempresas,\r\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'PEQUENO' THEN e.nu_cnpj END) AS total_pequenas,\r\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'MEDIO' THEN e.nu_cnpj END) AS total_medias,\r\n    COUNT(DISTINCT CASE WHEN e.porte_empresa = 'GRANDE' THEN e.nu_cnpj END) AS total_grandes,\r\n    \r\n    -- Métricas Financeiras Gerais\r\n    ROUND(SUM(e.vl_faturamento) / 1000000000, 2) AS faturamento_total_bilhoes,\r\n    ROUND(SUM(e.icms_devido) / 1000000000, 2) AS icms_devido_total_bilhoes,\r\n    ROUND(AVG(e.aliq_efetiva) * 100, 2) AS aliquota_media_sistema_pct,\r\n    \r\n    -- Métricas de Pagamentos\r\n    ROUND(SUM(p.valor_total_pago) / 1000000000, 2) AS pagamentos_total_bilhoes,\r\n    ROUND((SUM(e.icms_recolher) - SUM(p.valor_total_pago)) / 1000000, 2) AS diferenca_icms_pagto_milhoes,\r\n    \r\n    -- Métricas de Qualidade\r\n    COUNT(DISTINCT CASE WHEN e.sn_com_movimento = 1 THEN e.nu_cnpj END) AS empresas_ativas,\r\n    ROUND(COUNT(DISTINCT CASE WHEN e.sn_com_movimento = 1 THEN e.n",
    "last_modified": "2025-10-02T18:02:38.146",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a55ab5f4-6a18-484a-bf2b-fdbec7ccc1bd",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 159454,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SETORES: Top10 Faturamento CNAE",
    "description": "",
    "uuid": "6679443b-1621-aa3c-8241-2c381fc6f947",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 159454, \"uuid\": \"6679443b-1621-aa3c-8241-2c381fc6f947\", \"name\": \"SETORES: Top10 Faturamento CNAE\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0cebf361-38b4-7752-318a-11c0d878ed43\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 42, \"column\": 21}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"niat\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- Ver todos os per\\u00edodos desse setor\\r\\nSELECT \\r\\n    nu_per_ref,\\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    qtd_empresas_total,\\r\\n    ROUND(aliq_efetiva_media * 100, 4) AS aliq_media_pct,\\r\\n    ROUND(aliq_efetiva_mediana * 100, 4) AS aliq_mediana_pct,\\r\\n    ROUND(aliq_efetiva_min * 100, 4) AS aliq_min_pct,\\r\\n    ROUND(aliq_efetiva_max * 100, 4) AS aliq_max_pct,\\r\\n    ROUND(aliq_efetiva_desvio * 100, 4) AS aliq_desvio_pct\\r\\nFROM niat.argos_benchmark_setorial\\r\\nWHERE cnae_classe = '47113'\\r\\nORDER BY nu_per_ref;\\r\\n\\r\\n-- Ver al\\u00edquotas das empresas do setor\\r\\nSELECT \\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    nu_per_ref,\\r\\n    vl_faturamento,\\r\\n    icms_devido,\\r\\n    ROUND(aliq_efetiva * 100, 4) AS aliq_efetiva_pct,\\r\\n    aliq_efetiva AS aliq_bruto_original\\r\\nFROM niat.argos_empresas\\r\\nWHERE cnae_classe = '47113'\\r\\n  AND nu_per_ref = 202508\\r\\n  AND aliq_efetiva IS NOT NULL\\r\\nORDER BY aliq_efetiva DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- Identificar empresas com al\\u00edquotas an\\u00f4malas\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    COUNT(*) AS casos,\\r\\n    COUNT(CASE WHEN aliq_efetiva > 1 THEN 1 END) AS casos_acima_100pct,\\r\\n    COUNT(CASE WHEN aliq_efetiva > 2 THEN 1 END) AS casos_acima_200pct,\\r\\n    MAX(aliq_efetiva) AS aliq_maxima,\\r\\n    MIN(aliq_efetiva) AS aliq_minima\\r\\nFROM niat.argos_empresas\\r\\nWHERE cnae_classe = '47113'\\r\\n  AND aliq_efetiva IS NOT NULL\\r\\nGROUP BY cnae_classe;\\r\\n\\r\\n-- Dados que alimentam o ranking de faturamento\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\\r\\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\\r\\n    meses_analisados\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\nWHERE cnae_classe IN ('47113', '47318')\\r\\nORDER BY faturamento_acumulado_8m DESC;\", \"statementsList\": [\"-- Ver todos os per\\u00edodos desse setor\\r\\nSELECT \\r\\n    nu_per_ref,\\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    qtd_empresas_total,\\r\\n    ROUND(aliq_efetiva_media * 100, 4) AS aliq_media_pct,\\r\\n    ROUND(aliq_efetiva_mediana * 100, 4) AS aliq_mediana_pct,\\r\\n    ROUND(aliq_efetiva_min * 100, 4) AS aliq_min_pct,\\r\\n    ROUND(aliq_efetiva_max * 100, 4) AS aliq_max_pct,\\r\\n    ROUND(aliq_efetiva_desvio * 100, 4) AS aliq_desvio_pct\\r\\nFROM niat.argos_benchmark_setorial\\r\\nWHERE cnae_classe = '47113'\\r\\nORDER BY nu_per_ref;\", \"\\r\\n\\r\\n-- Ver al\\u00edquotas das empresas do setor\\r\\nSELECT \\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    nu_per_ref,\\r\\n    vl_faturamento,\\r\\n    icms_devido,\\r\\n    ROUND(aliq_efetiva * 100, 4) AS aliq_efetiva_pct,\\r\\n    aliq_efetiva AS aliq_bruto_original\\r\\nFROM niat.argos_empresas\\r\\nWHERE cnae_classe = '47113'\\r\\n  AND nu_per_ref = 202508\\r\\n  AND aliq_efetiva IS NOT NULL\\r\\nORDER BY aliq_efetiva DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- Identificar empresas com al\\u00edquotas an\\u00f4malas\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    COUNT(*) AS casos,\\r\\n    COUNT(CASE WHEN aliq_efetiva > 1 THEN 1 END) AS casos_acima_100pct,\\r\\n    COUNT(CASE WHEN aliq_efetiva > 2 THEN 1 END) AS casos_acima_200pct,\\r\\n    MAX(aliq_efetiva) AS aliq_maxima,\\r\\n    MIN(aliq_efetiva) AS aliq_minima\\r\\nFROM niat.argos_empresas\\r\\nWHERE cnae_classe = '47113'\\r\\n  AND aliq_efetiva IS NOT NULL\\r\\nGROUP BY cnae_classe;\", \"\\r\\n\\r\\n-- Dados que alimentam o ranking de faturamento\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\\r\\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\\r\\n    meses_analisados\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\nWHERE cnae_classe IN ('47113', '47318')\\r\\nORDER BY faturamento_acumulado_8m DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n-- Dados que alimentam o ranking de faturamento\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\\r\\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\\r\\n    meses_analisados\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\nWHERE cnae_classe IN ('47113', '47318')\\r\\nORDER BY faturamento_acumulado_8m DESC;\", \"result\": {\"id\": \"ab8d6948-9adf-3bda-05f5-2176290a19fb\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"HgQlQ5WfRe6qRHGeejN0Uw==\", \"guid\": \"0P11Gba9RH0AAAAAJjeeDQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ea4b3ab1fb1b5b55:e188e7f52b040787\", \"session_id\": 21232, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"1c8df46e004a1391bdf87a3c28b96c21e0b107a8e9b98a67ab6c67e6\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 387}, \"statement\": \"-- Dados que alimentam o ranking de faturamento\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\\r\\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\\r\\n    meses_analisados\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\nWHERE cnae_classe IN ('47113', '47318')\\r\\nORDER BY faturamento_acumulado_8m DESC\"}, \"meta\": [], \"rows\": 2, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 5, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"cnae_classe\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"desc_cnae_classe\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"aliq_mediana_media_8m_pct\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"faturamento_milhoes\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"meses_analisados\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 5}], \"fetchedOnce\": false, \"startTime\": \"2025-10-06T16:42:49.911Z\", \"endTime\": \"2025-10-06T16:42:51.237Z\", \"executionTime\": 1326, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"cnae_classe\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"faturamento_milhoes\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"cnae_classe\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"casos_acima_100pct\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 3222, \"getLogsTimeout\": 3258, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759768969644, \"lastAceSelectionRowOffset\": 53, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"\\r\\n\\r\\n-- Dados que alimentam o ranking de faturamento\\r\\nSELECT \\r\\n    cnae_classe,\\r\\n    desc_cnae_classe,\\r\\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\\r\\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\\r\\n    meses_analisados\\r\\nFROM niat.argos_evolucao_temporal_setor\\r\\nWHERE cnae_classe IN ('47113', '47318')\\r\\nORDER BY faturamento_acumulado_8m DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 53, \"column\": 39}, \"end\": {\"row\": 53, \"column\": 39}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 7d44bdb61975fdd0:0d9e372600000000 100% Complete (7 out of 7)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"7d44bdb61975fdd0:0d9e372600000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=7d44bdb61975fdd0:0d9e372600000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 7d44bdb61975fdd0:0d9e372600000000 100% Complete (7 out of 7)\", \"progress\": 100, \"jobs\": [{\"name\": \"7d44bdb61975fdd0:0d9e372600000000\", \"url\": \"/hue/jobbrowser#!id=7d44bdb61975fdd0:0d9e372600000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 9866.94778, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 101, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- Ver todos os períodos desse setor\r\nSELECT \r\n    nu_per_ref,\r\n    cnae_classe,\r\n    desc_cnae_classe,\r\n    qtd_empresas_total,\r\n    ROUND(aliq_efetiva_media * 100, 4) AS aliq_media_pct,\r\n    ROUND(aliq_efetiva_mediana * 100, 4) AS aliq_mediana_pct,\r\n    ROUND(aliq_efetiva_min * 100, 4) AS aliq_min_pct,\r\n    ROUND(aliq_efetiva_max * 100, 4) AS aliq_max_pct,\r\n    ROUND(aliq_efetiva_desvio * 100, 4) AS aliq_desvio_pct\r\nFROM niat.argos_benchmark_setorial\r\nWHERE cnae_classe = '47113'\r\nORDER BY nu_per_ref;\r\n\r\n-- Ver alíquotas das empresas do setor\r\nSELECT \r\n    nu_cnpj,\r\n    nm_razao_social,\r\n    nu_per_ref,\r\n    vl_faturamento,\r\n    icms_devido,\r\n    ROUND(aliq_efetiva * 100, 4) AS aliq_efetiva_pct,\r\n    aliq_efetiva AS aliq_bruto_original\r\nFROM niat.argos_empresas\r\nWHERE cnae_classe = '47113'\r\n  AND nu_per_ref = 202508\r\n  AND aliq_efetiva IS NOT NULL\r\nORDER BY aliq_efetiva DESC\r\nLIMIT 20;\r\n\r\n-- Identificar empresas com alíquotas anômalas\r\nSELECT \r\n    cnae_classe,\r\n    COUNT(*) AS casos,\r\n    COUNT(CASE WHEN aliq_efetiva > 1 THEN 1 END) AS casos_acima_100pct,\r\n    COUNT(CASE WHEN aliq_efetiva > 2 THEN 1 END) AS casos_acima_200pct,\r\n    MAX(aliq_efetiva) AS aliq_maxima,\r\n    MIN(aliq_efetiva) AS aliq_minima\r\nFROM niat.argos_empresas\r\nWHERE cnae_classe = '47113'\r\n  AND aliq_efetiva IS NOT NULL\r\nGROUP BY cnae_classe;\r\n\r\n-- Dados que alimentam o ranking de faturamento\r\nSELECT \r\n    cnae_classe,\r\n    desc_cnae_classe,\r\n    ROUND(aliq_mediana_media_8m * 100, 4) AS aliq_mediana_media_8m_pct,\r\n    ROUND(faturamento_acumulado_8m / 1e6, 2) AS faturamento_milhoes,\r\n    meses_analisados\r\nFROM niat.argos_evolucao_temporal_setor\r\nWHERE cnae_classe IN ('47113', '47318')\r\nORDER BY faturamento_acumulado_8m DESC;",
    "last_modified": "2025-10-06T13:43:21.998",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a55ab5f4-6a18-484a-bf2b-fdbec7ccc1bd",
      1,
      false
    ],
    "dependencies": []
  }
}
]
